<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.24">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Maria Tackett">
<title>13&nbsp; Special topics – Introduction to Regression Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./appendix-linear.html" rel="next">
<link href="./12-logistic-prediction.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dc55a5b9e770e841cd82e46aadbfb9b0.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-31c3c5ec0f84e3846e28bd1517aa8340.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script defer="" data-domain="https://matackett.github.io/regression-book/" src="https://plausible.io/js/script.js"></script><script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
</head>
<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./11-logistic.html">Part 4: Beyond linear regression</a></li><li class="breadcrumb-item"><a href="./13-special-topics.html"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Special topics</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="./index.html" class="sidebar-logo-link">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Introduction to Regression Analysis</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/matackett/regression-book" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00-preface.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Part 1: Getting started</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Regression in the data science workflow</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-review-r.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Data analysis in R</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-eda.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Exploratory data analysis</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Part 2: Simple linear regression</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-slr.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Simple linear regression</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-slr-inference.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Inference for simple linear regression</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-slr-conditions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Model conditions and diagnostics</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Part 3: Multiple linear regression</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-mlr.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Multiple linear regression</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-mlr-inference.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Inference for multiple linear regression</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-mlr-transformations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Variable transformations</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-model-eval.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Model selection</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Part 4: Beyond linear regression</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11-logistic.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Logistic regression</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12-logistic-prediction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Logistic regression: Prediction and evaluation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13-special-topics.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Special topics</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./appendix-linear.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Mathematics of linear regression</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./appendix-logistic.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Mathematics of logistic regression</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./datasets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Data sets</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#learning-goals" id="toc-learning-goals" class="nav-link active" data-scroll-target="#learning-goals">Learning goals</a></li>
  <li>
<a href="#sec-multinomial" id="toc-sec-multinomial" class="nav-link" data-scroll-target="#sec-multinomial"><span class="header-section-number">13.1</span> Multinomial logistic regression</a>
  <ul class="collapse">
<li><a href="#sec-voters-data" id="toc-sec-voters-data" class="nav-link" data-scroll-target="#sec-voters-data"><span class="header-section-number">13.1.1</span> Data: Voting frequency</a></li>
  <li><a href="#multinomial-logistic-model" id="toc-multinomial-logistic-model" class="nav-link" data-scroll-target="#multinomial-logistic-model"><span class="header-section-number">13.1.2</span> Multinomial logistic model</a></li>
  <li><a href="#interpretation" id="toc-interpretation" class="nav-link" data-scroll-target="#interpretation"><span class="header-section-number">13.1.3</span> Interpretation</a></li>
  <li><a href="#prediction-and-classification" id="toc-prediction-and-classification" class="nav-link" data-scroll-target="#prediction-and-classification"><span class="header-section-number">13.1.4</span> Prediction and classification</a></li>
  <li><a href="#confusion-matrix" id="toc-confusion-matrix" class="nav-link" data-scroll-target="#confusion-matrix"><span class="header-section-number">13.1.5</span> Confusion matrix</a></li>
  <li><a href="#roc-curves-and-auc" id="toc-roc-curves-and-auc" class="nav-link" data-scroll-target="#roc-curves-and-auc"><span class="header-section-number">13.1.6</span> ROC Curves and AUC</a></li>
  <li><a href="#multinomial-logistic-regression-in-r" id="toc-multinomial-logistic-regression-in-r" class="nav-link" data-scroll-target="#multinomial-logistic-regression-in-r"><span class="header-section-number">13.1.7</span> Multinomial logistic regression in R</a></li>
  <li><a href="#generalized-linear-models" id="toc-generalized-linear-models" class="nav-link" data-scroll-target="#generalized-linear-models"><span class="header-section-number">13.1.8</span> Generalized linear models</a></li>
  </ul>
</li>
  <li>
<a href="#sec-random-intercepts" id="toc-sec-random-intercepts" class="nav-link" data-scroll-target="#sec-random-intercepts"><span class="header-section-number">13.2</span> Random intercepts model</a>
  <ul class="collapse">
<li><a href="#data-lemurs" id="toc-data-lemurs" class="nav-link" data-scroll-target="#data-lemurs"><span class="header-section-number">13.2.1</span> Data: Lemurs</a></li>
  <li><a href="#model-fit-and-interpretation" id="toc-model-fit-and-interpretation" class="nav-link" data-scroll-target="#model-fit-and-interpretation"><span class="header-section-number">13.2.2</span> Model fit and interpretation</a></li>
  <li><a href="#random-intercepts-model-in-r" id="toc-random-intercepts-model-in-r" class="nav-link" data-scroll-target="#random-intercepts-model-in-r"><span class="header-section-number">13.2.3</span> Random intercepts model in R</a></li>
  <li><a href="#further-reading" id="toc-further-reading" class="nav-link" data-scroll-target="#further-reading"><span class="header-section-number">13.2.4</span> Further reading</a></li>
  </ul>
</li>
  <li>
<a href="#sec-decision-trees" id="toc-sec-decision-trees" class="nav-link" data-scroll-target="#sec-decision-trees"><span class="header-section-number">13.3</span> Decision trees</a>
  <ul class="collapse">
<li><a href="#sec-regression-trees" id="toc-sec-regression-trees" class="nav-link" data-scroll-target="#sec-regression-trees"><span class="header-section-number">13.3.1</span> Regression trees</a></li>
  <li><a href="#sec-classification-trees" id="toc-sec-classification-trees" class="nav-link" data-scroll-target="#sec-classification-trees"><span class="header-section-number">13.3.2</span> Classification trees</a></li>
  <li><a href="#decision-trees-in-r" id="toc-decision-trees-in-r" class="nav-link" data-scroll-target="#decision-trees-in-r"><span class="header-section-number">13.3.3</span> Decision trees in R</a></li>
  <li><a href="#further-reading-1" id="toc-further-reading-1" class="nav-link" data-scroll-target="#further-reading-1"><span class="header-section-number">13.3.4</span> Further reading</a></li>
  </ul>
</li>
  <li>
<a href="#sec-causal" id="toc-sec-causal" class="nav-link" data-scroll-target="#sec-causal"><span class="header-section-number">13.4</span> Causal inference</a>
  <ul class="collapse">
<li><a href="#propensity-score-matching" id="toc-propensity-score-matching" class="nav-link" data-scroll-target="#propensity-score-matching"><span class="header-section-number">13.4.1</span> Propensity score matching</a></li>
  <li><a href="#causal-inference-in-r" id="toc-causal-inference-in-r" class="nav-link" data-scroll-target="#causal-inference-in-r"><span class="header-section-number">13.4.2</span> Causal inference in R</a></li>
  <li><a href="#sec-causal-further-reading" id="toc-sec-causal-further-reading" class="nav-link" data-scroll-target="#sec-causal-further-reading"><span class="header-section-number">13.4.3</span> Further reading</a></li>
  </ul>
</li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">13.5</span> Summary</a></li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/matackett/regression-book/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./11-logistic.html">Part 4: Beyond linear regression</a></li><li class="breadcrumb-item"><a href="./13-special-topics.html"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Special topics</span></a></li></ol></nav><div class="quarto-title">
<h1 class="title"><span id="sec-ch-special-topics" class="quarto-section-identifier"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Special topics</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><section id="learning-goals" class="level2 unnumbered"><h2 class="unnumbered anchored" data-anchor-id="learning-goals">Learning goals</h2>
<p>This chapter introduces readers to a collection to models that are extensions of linear and logistic regression. The goal is to provide an introduction to the topic along with resources for those interested in learning more. The following topics are introduced:</p>
<ul>
<li>Multinomial logistic regression</li>
<li>Random intercepts models</li>
<li>Decision trees for regression and classification</li>
<li>Causal inference using propensity score models</li>
</ul></section><section id="sec-multinomial" class="level2" data-number="13.1"><h2 data-number="13.1" class="anchored" data-anchor-id="sec-multinomial">
<span class="header-section-number">13.1</span> Multinomial logistic regression</h2>
<p>In <a href="11-logistic.html" class="quarto-xref"><span>Chapter 11</span></a>, we introduced logistic regression models for binary response variables. In this section, we introduce multinomial logistic regression, models for categorical response variables with three or more levels.</p>
<section id="sec-voters-data" class="level3" data-number="13.1.1"><h3 data-number="13.1.1" class="anchored" data-anchor-id="sec-voters-data">
<span class="header-section-number">13.1.1</span> Data: Voting frequency</h3>
<p>In the 2020 article “Why Many Americans Don’t Vote” <span class="citation" data-cites="ThomsonDeVeaux_et_al_2020">(<a href="references.html#ref-ThomsonDeVeaux_et_al_2020" role="doc-biblioref">Thomson-DeVeaux, Mithani, and Bronner 2020</a>)</span> on the now defunct data journalism website FiveThirtyEight, journalists explored the voting behavior of eligible voters in the United States. <!--# maybe add something else here about the article--> As indicated by the article’s title, their primary objective was to understand why many eligible voters choose not to vote at all or only vote sporadically. <!--# include something here about the data collection--> They considered numerous factors in their analysis, but we will focus on a few, age and political affiliation, for this analysis. <!--# need to include somewhere that this is includes people who were eligible in the last four elections--></p>
<p>The data were obtained from the FiveThirtyEight data website (<a href="https://data.fivethirtyeight.com/">https://data.fivethirtyeight.com</a>) and is available in <code>fivethirtyeight-voters-data.csv</code>. It contains survey responses <!--# is survey correct?--> from 5836 respondents. All survey participants had been eligible to vote in at least four prior elections. The variables used in this analysis are below. The definitions are adapted from the data documentation (<a href="https://github.com/fivethirtyeight/data/tree/master/non-voters" class="uri">https://github.com/fivethirtyeight/data/tree/master/non-voters</a>)</p>
<ul>
<li>
<p><code>voter_category</code>: An respondent’s past voting behavior, categorized as</p>
<ul>
<li><p><code>always</code>: respondent voted in all or all-but-one of the elections they were eligible in</p></li>
<li><p><code>sporadic</code>: respondent voted in at least two, but fewer than all-but-one of the elections they were eligible in</p></li>
<li><p><code>rarely/never</code>: respondent voted in 0 or 1 of the elections they were eligible in</p></li>
</ul>
</li>
<li><p><code>age</code>: Respondent’s age in years (called <code>ppage</code> in original data set)</p></li>
<li>
<p><code>party_id</code>: Respondent’s political affiliation categorized as <code>Democrat</code>, <code>Republican</code> , <code>No affiliation</code>. This variable was derived from the variable <code>Q30</code> in the original data set, defined as the following:</p>
<ul>
<li>
<p><em>Response to the question “Generally speaking, do you think of yourself as a…”</em></p>
<ul>
<li><p><em>1:Republican</em></p></li>
<li><p><em>2: Democrat</em></p></li>
<li><p><em>3: Independent</em></p></li>
<li><p><em>4: Another party, please specify</em></p></li>
<li><p><em>5: No preference</em></p></li>
<li><p><em>-1: No response</em></p></li>
</ul>
</li>
<li><p>Responses <code>3, 4, 5,-1</code> are classified as “No affiliation” in this analysis.</p></li>
</ul>
</li>
<li><p><code>income_cat</code>: Respondent’s annual income (<code>Less than $40k</code>, <code>$40-75k</code>, <code>$75-125k</code>, <code>$125k or more</code>)</p></li>
</ul>
<p>The goal of this analysis is to use <code>age</code> and <code>party_id</code> to predict <code>voting_id</code> and describe factors associated with variability in voting behavior. The univariate exploratory data analysis is in <a href="#fig-voting-univar-eda" class="quarto-xref">Figure&nbsp;<span>13.1</span></a> and <a href="#tbl-voting-univar-eda" class="quarto-xref">Table&nbsp;<span>13.1</span></a>.</p>
<div class="cell" data-layout="[[1], [1,1]]">
<div id="fig-voting-univar-eda" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-voting-univar-eda-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-voting-univar-eda" style="flex-basis: 100.0%;justify-content: flex-start;">
<div id="fig-voting-univar-eda-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-voting-univar-eda-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="13-special-topics_files/figure-html/fig-voting-univar-eda-1.png" class="lightbox" data-gallery="fig-voting-univar-eda" title="Figure&nbsp;13.1&nbsp;(a): voter_category"><img src="13-special-topics_files/figure-html/fig-voting-univar-eda-1.png" class="img-fluid figure-img" style="width:100.0%" data-ref-parent="fig-voting-univar-eda"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-voting-univar-eda-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) <code>voter_category</code>
</figcaption></figure>
</div>
</div>
</div>
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-voting-univar-eda" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-voting-univar-eda-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-voting-univar-eda-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="13-special-topics_files/figure-html/fig-voting-univar-eda-2.png" class="lightbox" data-gallery="fig-voting-univar-eda" title="Figure&nbsp;13.1&nbsp;(b): age"><img src="13-special-topics_files/figure-html/fig-voting-univar-eda-2.png" class="img-fluid figure-img" style="width:100.0%" data-ref-parent="fig-voting-univar-eda"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-voting-univar-eda-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) <code>age</code>
</figcaption></figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-voting-univar-eda" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-voting-univar-eda-3" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-voting-univar-eda-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="13-special-topics_files/figure-html/fig-voting-univar-eda-3.png" class="lightbox" data-gallery="fig-voting-univar-eda" title="Figure&nbsp;13.1&nbsp;(c): party_id"><img src="13-special-topics_files/figure-html/fig-voting-univar-eda-3.png" class="img-fluid figure-img" style="width:100.0%" data-ref-parent="fig-voting-univar-eda"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-voting-univar-eda-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c) <code>party_id</code>
</figcaption></figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-voting-univar-eda-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13.1: Univariate EDA for voting frequency data
</figcaption></figure>
</div>
</div>
<div class="cell">
<div id="tbl-voting-univar-eda" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-voting-univar-eda-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;13.1: Summary statistics for <code>age</code>
</figcaption><div aria-describedby="tbl-voting-univar-eda-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead><tr class="header">
<th style="text-align: left;">Variable</th>
<th style="text-align: right;">Mean</th>
<th style="text-align: right;">SD</th>
<th style="text-align: right;">Min</th>
<th style="text-align: right;">Q1</th>
<th style="text-align: right;">Median (Q2)</th>
<th style="text-align: right;">Q3</th>
<th style="text-align: right;">Max</th>
<th style="text-align: right;">Missing</th>
</tr></thead>
<tbody><tr class="odd">
<td style="text-align: left;">age</td>
<td style="text-align: right;">51.7</td>
<td style="text-align: right;">17.1</td>
<td style="text-align: right;">22</td>
<td style="text-align: right;">36</td>
<td style="text-align: right;">54</td>
<td style="text-align: right;">65</td>
<td style="text-align: right;">94</td>
<td style="text-align: right;">0</td>
</tr></tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>The most common voting frequency among respondents in <code>sporadic</code>, with 44.1% of the voters being in this category. About 24.9% of the respondents vote rarely or never, and 31% of the respondents voted always. The distribution of <code>age</code> is bimodal and skewed right. The median age in the data set is 54 years old, and the IQR is 29 years. The most common political party identification is “No affiliation” with about 38.4% of the respondents. About 34.3% of the respondents identified as “Democrat” and about 27.3% as “Republican”.</p>
<div id="fig-voting-bivar-eda" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-voting-bivar-eda-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-voting-bivar-eda" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-voting-bivar-eda-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-voting-bivar-eda-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="13-special-topics_files/figure-html/fig-voting-bivar-eda-1.png" class="lightbox" data-gallery="fig-voting-bivar-eda" title="Figure&nbsp;13.2&nbsp;(a): voter_category versus age"><img src="13-special-topics_files/figure-html/fig-voting-bivar-eda-1.png" class="img-fluid figure-img" style="width:100.0%" data-ref-parent="fig-voting-bivar-eda"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-voting-bivar-eda-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) <code>voter_category</code> versus <code>age</code>
</figcaption></figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-voting-bivar-eda" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-voting-bivar-eda-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-voting-bivar-eda-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="13-special-topics_files/figure-html/fig-voting-bivar-eda-2.png" class="lightbox" data-gallery="fig-voting-bivar-eda" title="Figure&nbsp;13.2&nbsp;(b): voter_category versus party_id"><img src="13-special-topics_files/figure-html/fig-voting-bivar-eda-2.png" class="img-fluid figure-img" style="width:100.0%" data-ref-parent="fig-voting-bivar-eda"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-voting-bivar-eda-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) <code>voter_category</code> versus <code>party_id</code>
</figcaption></figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-voting-bivar-eda-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13.2: Bivariate EDA for voting frequency data. Blue: rarely/never, Red: sporadic, Yellow: always
</figcaption></figure>
</div>
<p>The bivariate exploratory data analysis is in <a href="#fig-voting-bivar-eda" class="quarto-xref">Figure&nbsp;<span>13.2</span></a>. From <a href="#fig-voting-bivar-eda-1" class="quarto-xref">Figure&nbsp;<span>13.2 (a)</span></a>, the distribution of <code>age</code> among voters categorized as “always” is bimodal with a peak around 25 years old and another around 60 years old. In contrast, the distribution of <code>age</code> among voters categorized as “rarely/never” is unimodal and skewed towards younger voters. This suggest there may be a relationship between age and voting frequency.</p>
<p>From <a href="#fig-voting-bivar-eda-2" class="quarto-xref">Figure&nbsp;<span>13.2 (b)</span></a>, the voters who have no political party affiliation are the most likely to vote “rarely/never” and the least likely to vote “always”. The distribution of voting frequency appears to be similar between Democrats and Republicans. This indicates there may be some relationship between political party identification (or even whether or not someone identifies with a political party) and voting frequency.</p>
<p>We have some initial insights from the data about overall voting frequency and potential relationships with age and political party affiliation, so we want to fit a model to summarize the relationship between these variables that we can use to draw robust conclusions and make predictions.</p>
</section><section id="multinomial-logistic-model" class="level3" data-number="13.1.2"><h3 data-number="13.1.2" class="anchored" data-anchor-id="multinomial-logistic-model">
<span class="header-section-number">13.1.2</span> Multinomial logistic model</h3>
<p>The response variable in this analysis has three levels, so we will use an extension of the logistic regression model. <strong>Multinomial logistic regression</strong> is part of the wider class of models called <em>generalized linear models</em>. It is a model for data with a categorical response variable that has three or more levels. Such response variables follow a multinomial distribution.</p>
<div class="math_rules">
<p><strong>Multinomial distribution</strong></p>
<p>Let <span class="math inline">\(Y\)</span> be a categorical random variable with <span class="math inline">\(K &gt; 2\)</span> levels. Then,</p>
<p><span class="math display">\[P(Y = 1) = \pi_1, P(Y = 2) = \pi_2, \ldots, P(Y = K) = \pi_K\]</span> such that <span class="math inline">\(\sum_{k=1}^K \pi_K = 1\)</span></p>
</div>
<p>Let’s look at the general form of the multinomial logistic regression model, then apply it to model voting frequency. Suppose we have a categorical response variable that takes values <span class="math inline">\(A\)</span>, <span class="math inline">\(B\)</span>, and <span class="math inline">\(C\)</span>. Let <span class="math inline">\(A\)</span> be the baseline level. Then, the general form of the multinomial logistic regression model is</p>
<p><span id="eq-multinom-general"><span class="math display">\[\begin{aligned}
\log\Big(\frac{\pi_B}{\pi_A}\Big) = \beta_{0
B} + \beta_{1B}X_1 +\beta_{2B}X_2 + \dots + \beta_{pB}X_p \\
\log\Big(\frac{\pi_C}{\pi_A}\Big) = \beta_{0C} + \beta_{1C}X_1 +\beta_{2C}X_2 + \dots + \beta_{pC}X_p
\end{aligned}
\tag{13.1}\]</span></span></p>
<p>From <a href="#eq-multinom-general" class="quarto-xref">Equation&nbsp;<span>13.1</span></a>, we see a few features of the multinomial logistic model. We start by choosing a baseline level for the response variable. Each equation in the fitted model quantifies the log odds of being at another level of the response variable versus the baseline<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. WE saw this implicitly in logistic regression, where the response variable, <span class="math inline">\(\log(\frac{\pi}{1-\pi})\)</span>, is the “log odds of <span class="math inline">\(Y = 1\)</span> versus <span class="math inline">\(Y = 0\)</span>.”</p>
<p>The next feature of multinomial logistic regression is the multiple equations that comprise the model. More specifically, if the response variable has <span class="math inline">\(K\)</span> levels, then there will be <span class="math inline">\(K - 1\)</span> equations in the model. We will ultimately use the model to compute the predicted probabilities an observation takes each level of the response variable, so we need all <span class="math inline">\(K-1\)</span> equations in order to compute the predicted probabilities for every level of the response variable.</p>
<p>The last feature is that each of the <span class="math inline">\(K -1\)</span> equations have the same form but different values of the coefficients. This is shown in <a href="#eq-multinom-general" class="quarto-xref">Equation&nbsp;<span>13.1</span></a> as the <span class="math inline">\(\beta's\)</span> have unique indices in each equation. As with logistic regression, the coefficients for multinomial logistic regression are estimated using maximum likelihood estimation (<a href="11-logistic.html#sec-logistic-interpret-coef" class="quarto-xref">see&nbsp;<span>11.4</span></a>).</p>
<p><a href="#tbl-voter-model" class="quarto-xref">Table&nbsp;<span>13.2</span></a> is the multinomial logistic regression model using <code>age</code> and <code>party_id</code> to predict <code>voter_category</code>.</p>
<div class="cell">
<div id="tbl-voter-model" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-voter-model-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;13.2: Model of <code>voter_category</code> versus <code>age</code> and <code>party_id</code> with 95% confidence intervals for the coefficients
</figcaption><div aria-describedby="tbl-voter-model-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 10%">
<col style="width: 26%">
<col style="width: 10%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 9%">
<col style="width: 10%">
<col style="width: 11%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">y.level</th>
<th style="text-align: left;">term</th>
<th style="text-align: right;">estimate</th>
<th style="text-align: right;">std.error</th>
<th style="text-align: right;">statistic</th>
<th style="text-align: right;">p.value</th>
<th style="text-align: right;">conf.low</th>
<th style="text-align: right;">conf.high</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">sporadic</td>
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: right;">-1.046</td>
<td style="text-align: right;">0.116</td>
<td style="text-align: right;">-9.031</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">-1.273</td>
<td style="text-align: right;">-0.819</td>
</tr>
<tr class="even">
<td style="text-align: left;">sporadic</td>
<td style="text-align: left;">age</td>
<td style="text-align: right;">0.041</td>
<td style="text-align: right;">0.002</td>
<td style="text-align: right;">18.834</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.036</td>
<td style="text-align: right;">0.045</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sporadic</td>
<td style="text-align: left;">party_idNo affiliation</td>
<td style="text-align: right;">-0.677</td>
<td style="text-align: right;">0.081</td>
<td style="text-align: right;">-8.389</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">-0.836</td>
<td style="text-align: right;">-0.519</td>
</tr>
<tr class="even">
<td style="text-align: left;">sporadic</td>
<td style="text-align: left;">party_idRepublican</td>
<td style="text-align: right;">-0.106</td>
<td style="text-align: right;">0.095</td>
<td style="text-align: right;">-1.118</td>
<td style="text-align: right;">0.264</td>
<td style="text-align: right;">-0.292</td>
<td style="text-align: right;">0.080</td>
</tr>
<tr class="odd">
<td style="text-align: left;">always</td>
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: right;">-1.983</td>
<td style="text-align: right;">0.131</td>
<td style="text-align: right;">-15.157</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">-2.240</td>
<td style="text-align: right;">-1.727</td>
</tr>
<tr class="even">
<td style="text-align: left;">always</td>
<td style="text-align: left;">age</td>
<td style="text-align: right;">0.052</td>
<td style="text-align: right;">0.002</td>
<td style="text-align: right;">22.144</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.048</td>
<td style="text-align: right;">0.057</td>
</tr>
<tr class="odd">
<td style="text-align: left;">always</td>
<td style="text-align: left;">party_idNo affiliation</td>
<td style="text-align: right;">-0.872</td>
<td style="text-align: right;">0.089</td>
<td style="text-align: right;">-9.824</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">-1.046</td>
<td style="text-align: right;">-0.698</td>
</tr>
<tr class="even">
<td style="text-align: left;">always</td>
<td style="text-align: left;">party_idRepublican</td>
<td style="text-align: right;">-0.091</td>
<td style="text-align: right;">0.101</td>
<td style="text-align: right;">-0.901</td>
<td style="text-align: right;">0.368</td>
<td style="text-align: right;">-0.288</td>
<td style="text-align: right;">0.106</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>The column <code>y.level</code> indicates the corresponding level for the given equation. The level of the response variable that is not listed is the baseline. In this case, the baseline level is <code>rarely/never</code>. Therefore, this model produces the log odds of being in the other categories versus rarely/ never.</p>
<p>We can write the model in <a href="#tbl-voter-model" class="quarto-xref">Table&nbsp;<span>13.2</span></a> as the following:</p>
<p><span class="math display">\[
\begin{aligned}
\log\Big(\frac{\pi_{sporadic}}{\pi_{rarely/never}}\Big)  = -1.046 + 0.041 \times \text{age} -0.677 \times \text{No affiliation} -0.106 \times \text{Republican} \\
\log\Big(\frac{\pi_{always}}{\pi_{rarely/never}}\Big)  = -1.983 + 0.052 \times \text{age} -0.872 \times \text{No affiliation}  -0.091 \times \text{Republican}
\end{aligned}
\]</span></p>
</section><section id="interpretation" class="level3" data-number="13.1.3"><h3 data-number="13.1.3" class="anchored" data-anchor-id="interpretation">
<span class="header-section-number">13.1.3</span> Interpretation</h3>
<p>The interpretation for the coefficients of the multinomial logistic model are very similar to the interpretations for the logistic model in <a href="11-logistic.html#sec-logistic-interpret-coef" class="quarto-xref"><span>Section 11.4</span></a>. Like logistic regression, the model coefficients represent the change in the log odds, but in practice want to write interpretations in terms of the odds. The primary difference in the interpretation is the explicit statement of the baseline level of the response variable.</p>
<p>Let’s interpret the coefficients in terms of having the voter frequency of <code>sporadic</code> versus <code>rarely/never</code>. The interpretation of <code>age</code> in terms of the log odds is as follows:</p>
<blockquote class="blockquote">
<p><em>For each additional year older, the log odds of an individual voting sporadically versus rarely/never are expected to increase by 0.041, holding political affiliation constant.</em></p>
</blockquote>
<p>The interpretation in terms of the odds is the following:</p>
<blockquote class="blockquote">
<p><strong>For each additional year older, the</strong> <b>odds</b> of an individual voting sporadically versus rarely/never are expected to multiply by 1.042 <span class="math inline">\((e^{0.041})\)</span>, holding political affiliation constant.</p>
</blockquote>
<p>Next, we interpret the effect of political affiliation on the voting frequency. As with other models, we write the interpretation in reference to the baseline level of the categorical predictor. The interpretation of the coefficients for <code>party_id</code> in terms of the log odds are the following:</p>
<blockquote class="blockquote">
<p><em>The log odds an individual who has no political affiliation votes sporadically versus rarely/never are 0.677 less than the log odds of an individual whose party affiliation is Democrat, holding age constant.</em></p>
</blockquote>
<blockquote class="blockquote">
<p><em>The log odds an individual whose political affiliation is Republican votes sporadically versus rarely/never are 0.106 less than the log odds of an individual whose party affiliation is Democrat, holding age constant.</em></p>
</blockquote>
<p>The interpretations in terms of the odds are as follows:</p>
<blockquote class="blockquote">
<p><em>The</em> <b>odds</b> an individual who has no political affiliation votes sporadically versus rarely/never are 0.508 <span class="math inline">\((e^{-0.872})\)</span> times the odds of an individual whose party affiliation is Democrat, holding age constant.</p>
</blockquote>
<blockquote class="blockquote">
<p><em>The</em> <b>odds</b> an individual whose political affiliation is Republican votes sporadically versus rarely/never are 0.899 <span class="math inline">\((e^{-0.106})\)</span> times the odds of an individual whose party affiliation is Democrat, holding age constant.</p>
</blockquote>
<p>Along with the coefficients in <a href="#tbl-voter-model" class="quarto-xref">Table&nbsp;<span>13.2</span></a> are 95% confidence intervals for the population coefficients. These confidence intervals are estimated in a similar way as those for logistic regression in <a href="11-logistic.html#sec-logistic-inf" class="quarto-xref"><span>Section 11.5</span></a>. As with previous models, we look to see whether the confidence interval contains 0 to determine whether it is a useful predictor in explaining variability in voting frequency after adjusting for the other predictors. In both equations in <a href="#tbl-voter-model" class="quarto-xref">Table&nbsp;<span>13.2</span></a>, none of the confidence intervals for <code>age</code> and <code>party_idNoaffiliation</code> include 0. Thus, both of these indicators are helpful in understanding voting frequency. In contrast, the confidence intervals for <code>party_idRepublican</code> do contain 0, so the voting behavior for Republicans does not differ significantly from Democrats, after adjusting for age. This is consistent with the observations from <a href="#fig-voting-bivar-eda-2" class="quarto-xref">Figure&nbsp;<span>13.2 (b)</span></a>.</p>
<div class="analysis_in_practice">
<p>In <a href="#tbl-voter-model" class="quarto-xref">Table&nbsp;<span>13.2</span></a>, the inferential conclusions for each predictor are the same for both equations in the multinomial logistic model. This is not a requirement for multinomial logistic regression and is not always the case. It could be possible for a predictor to be useful in differentiating <code>always</code> versus <code>rarely/never</code>, but not useful in differentiating <code>sporadic</code> versus <code>rarely/never</code>.</p>
</div>
</section><section id="prediction-and-classification" class="level3" data-number="13.1.4"><h3 data-number="13.1.4" class="anchored" data-anchor-id="prediction-and-classification">
<span class="header-section-number">13.1.4</span> Prediction and classification</h3>
<p>We often want to use multinomial logistic regression models for prediction, and more specifically classifying observations into the groups defined by the response variable. We can use the log odds produced by the multinomial logistic model to compute probabilities, then use those probabilities for classification.</p>
<p>Let’s go back to the general form of the model in <a href="#eq-multinom-general" class="quarto-xref">Equation&nbsp;<span>13.1</span></a>. The predicted probability an observation is in category <span class="math inline">\(B\)</span> is computed as</p>
<p><span id="eq-multinom-pred-prob"><span class="math display">\[
\hat{\pi}_B = \frac{e^{\beta_{0B} + \beta_{1B}X_1 + \beta_{2B}X_2 + \dots + \beta_{pB}X_p}}{1 + \sum_{k \in (B,C)}e^{\beta_{0k} + \beta_{1k}X_1 + \beta_{2k}X_2 + \dots + \beta_{pk}X_p}}
\tag{13.2}\]</span></span></p>
<!--# do i want to do the subscript i?-->
<p>The numerator of <a href="#eq-multinom-pred-prob" class="quarto-xref">Equation&nbsp;<span>13.2</span></a> are the odds of an observation being in category <span class="math inline">\(B\)</span> versus the baseline <span class="math inline">\(A\)</span>. The denominator is the sum of the odds for every possible level. In this example, it is the sum of the odds an observation is in category <span class="math inline">\(A\)</span> versus <span class="math inline">\(A\)</span> (that’s the “1” in the denominator), the odds an observation is in category <span class="math inline">\(B\)</span> versus <span class="math inline">\(A\)</span>, and the odds an observation is in category <span class="math inline">\(C\)</span> versus <span class="math inline">\(A\)</span>. A similar formula is used to compute <span class="math inline">\(\hat{p}_c\)</span>, the predicted probability of being in category <span class="math inline">\(C\)</span>. The difference is the numerator, which would be the odds of being in category <span class="math inline">\(C\)</span> versus <span class="math inline">\(A\)</span>.</p>
<p>The predicted probability an observation is in the baseline category <span class="math inline">\(A\)</span> is computed as</p>
<p><span id="eq-multinom-pred-baseline"><span class="math display">\[
\hat{\pi}_A = 1 - (\hat{\pi}_B + \hat{\pi}_C)
\tag{13.3}\]</span></span></p>
<p><a href="#eq-multinom-pred-baseline" class="quarto-xref">Equation&nbsp;<span>13.3</span></a> utilizes the fact that the sum of the probabilities across all possible categories equals 1. This is is also why we need all <span class="math inline">\(K - 1\)</span> equations as part of the multinomial logistic when there are <span class="math inline">\(K\)</span> categories of the response variable.</p>
<p><a href="#tbl-voter-model-pred" class="quarto-xref">Table&nbsp;<span>13.3</span></a> shows the predicted probabilities based on <a href="#tbl-voter-model" class="quarto-xref">Table&nbsp;<span>13.2</span></a> for ten observations in the data.</p>
<div class="cell">
<div id="tbl-voter-model-pred" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-voter-model-pred-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;13.3: Predictions from voter frequency model for ten observations
</figcaption><div aria-describedby="tbl-voter-model-pred-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead><tr class="header">
<th style="text-align: left;">voter_category</th>
<th style="text-align: right;">rarely/never</th>
<th style="text-align: right;">sporadic</th>
<th style="text-align: right;">always</th>
<th style="text-align: left;">pred_class</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">always</td>
<td style="text-align: right;">0.071</td>
<td style="text-align: right;">0.484</td>
<td style="text-align: right;">0.446</td>
<td style="text-align: left;">sporadic</td>
</tr>
<tr class="even">
<td style="text-align: left;">always</td>
<td style="text-align: right;">0.069</td>
<td style="text-align: right;">0.483</td>
<td style="text-align: right;">0.447</td>
<td style="text-align: left;">sporadic</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sporadic</td>
<td style="text-align: right;">0.160</td>
<td style="text-align: right;">0.486</td>
<td style="text-align: right;">0.354</td>
<td style="text-align: left;">sporadic</td>
</tr>
<tr class="even">
<td style="text-align: left;">sporadic</td>
<td style="text-align: right;">0.132</td>
<td style="text-align: right;">0.490</td>
<td style="text-align: right;">0.379</td>
<td style="text-align: left;">sporadic</td>
</tr>
<tr class="odd">
<td style="text-align: left;">always</td>
<td style="text-align: right;">0.055</td>
<td style="text-align: right;">0.466</td>
<td style="text-align: right;">0.479</td>
<td style="text-align: left;">always</td>
</tr>
<tr class="even">
<td style="text-align: left;">rarely/never</td>
<td style="text-align: right;">0.220</td>
<td style="text-align: right;">0.470</td>
<td style="text-align: right;">0.310</td>
<td style="text-align: left;">sporadic</td>
</tr>
<tr class="odd">
<td style="text-align: left;">always</td>
<td style="text-align: right;">0.057</td>
<td style="text-align: right;">0.468</td>
<td style="text-align: right;">0.475</td>
<td style="text-align: left;">always</td>
</tr>
<tr class="even">
<td style="text-align: left;">always</td>
<td style="text-align: right;">0.087</td>
<td style="text-align: right;">0.488</td>
<td style="text-align: right;">0.424</td>
<td style="text-align: left;">sporadic</td>
</tr>
<tr class="odd">
<td style="text-align: left;">always</td>
<td style="text-align: right;">0.088</td>
<td style="text-align: right;">0.479</td>
<td style="text-align: right;">0.433</td>
<td style="text-align: left;">sporadic</td>
</tr>
<tr class="even">
<td style="text-align: left;">always</td>
<td style="text-align: right;">0.093</td>
<td style="text-align: right;">0.489</td>
<td style="text-align: right;">0.417</td>
<td style="text-align: left;">sporadic</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>The predicted probabilities are then used to classify the observations based on the model. For each observation, the predicted class is the one with the highest predicted probability. For example, for the first observation in <a href="#tbl-voter-model-pred" class="quarto-xref">Table&nbsp;<span>13.3</span></a>, <span class="math inline">\(\hat{\pi}_{rarely/never} = 0.071\)</span>, <span class="math inline">\(\hat{\pi}_{sporadic} = 0.484\)</span>, and <span class="math inline">\(\hat{\pi}_{always} = 0.446\)</span>. Therefore, the predicted class for this observation is “sporadic”.</p>
</section><section id="confusion-matrix" class="level3" data-number="13.1.5"><h3 data-number="13.1.5" class="anchored" data-anchor-id="confusion-matrix">
<span class="header-section-number">13.1.5</span> Confusion matrix</h3>
<p>From <a href="#tbl-voter-model-pred" class="quarto-xref">Table&nbsp;<span>13.3</span></a>, we see the predicted class is not always equal to the observed class. Therefore, we want to quantify the model performance, specifically how well the model classifies observations and how well it distinguishes observations from a specific class. A confusion matrix, introduced in <a href="12-logistic-prediction.html#sec-classification" class="quarto-xref"><span>Section 12.3.2</span></a>, is used to compare the observed versus predicted classes. <a href="#fig-confmat-voters-model" class="quarto-xref">Figure&nbsp;<span>13.3</span></a> is the confusion matrix for the model in <a href="#tbl-voter-model" class="quarto-xref">Table&nbsp;<span>13.2</span></a>. Because the predicted class is always the category with the highest predicted probability, we do not need to specify a threshold as in logistic regression.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-confmat-voters-model" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-confmat-voters-model-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="13-special-topics_files/figure-html/fig-confmat-voters-model-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6" title="Figure&nbsp;13.3: Confusion matrix for voters model"><img src="13-special-topics_files/figure-html/fig-confmat-voters-model-1.png" class="img-fluid figure-img" style="width:100.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-confmat-voters-model-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13.3: Confusion matrix for voters model
</figcaption></figure>
</div>
</div>
</div>
<div class="yourturn">
<p>Use <a href="#fig-confmat-voters-model" class="quarto-xref">Figure&nbsp;<span>13.3</span></a> to compute</p>
<ul>
<li><p>the accuracy.</p></li>
<li><p>the misclassification rate<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p></li>
</ul>
<p>There are 5836 observations in the data.</p>
</div>
<p><a href="#fig-confmat-voters-model" class="quarto-xref">Figure&nbsp;<span>13.3</span></a> can also be used to compute more specific statistics about how well the model identifies observations from a particular class. For example, among those who are actually classified voting rarely/never, the model correctly identified 38.801 % of them.</p>
<p>Conversely, among those who were classified by the model as rarely/never, 49.343% of them actually vote rarely/never.</p>
</section><section id="roc-curves-and-auc" class="level3" data-number="13.1.6"><h3 data-number="13.1.6" class="anchored" data-anchor-id="roc-curves-and-auc">
<span class="header-section-number">13.1.6</span> ROC Curves and AUC</h3>
<p>Receiver Operating Characteristic (ROC) curves, introduced in <a href="12-logistic-prediction.html#sec-roc" class="quarto-xref"><span>Section 12.4</span></a>, can be used to evaluate how well the model distinguishes observations from a particular category. To do so, we create <strong>multiclass ROC curves</strong> using a “one versus all” approach that evaluates how well the model distinguishes one category versus all the others. For example, one curve represents how well the model distinguishes “always” voters versus all the others (“rarely/never” and “sporadic”). Essentially, we compute a logistic regression ROC curve for each possible class of the response.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-voters-roc-curve" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-voters-roc-curve-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="13-special-topics_files/figure-html/fig-voters-roc-curve-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7" title="Figure&nbsp;13.4: Multiclass ROC curves for the voter frequency model in Table&nbsp;tbl-voter-model"><img src="13-special-topics_files/figure-html/fig-voters-roc-curve-1.png" class="img-fluid figure-img" style="width:100.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-voters-roc-curve-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13.4: Multiclass ROC curves for the voter frequency model in <a href="#tbl-voter-model" class="quarto-xref">Table&nbsp;<span>13.2</span></a>
</figcaption></figure>
</div>
</div>
</div>
<p><a href="#fig-voters-roc-curve" class="quarto-xref">Figure&nbsp;<span>13.4</span></a> shows the multiclass ROC curve for the model in <a href="#tbl-voter-model" class="quarto-xref">Table&nbsp;<span>13.2</span></a>. We interpret this curve similarly to the ROC curve for logistic regression. Curves close to the upper-left portion of the graph indicate good model distinguishing, but curves close to the diagonal line indicate poor model distinguishing. Based on this, the model performs best in identifying “rarely/never” voters versus the others and does the worst in identifying sporadic voters.</p>
<p>The overall model performance is quantified using the <strong>average area under the curve (AUC)</strong>. The average AUC is computed in two ways. The first by computing the AUC for each class, then taking the average across all values of AUC. The average AUC for <a href="#fig-voters-roc-curve" class="quarto-xref">Figure&nbsp;<span>13.4</span></a> is 0.656 . The second approach is to weight the AUC by the number of observations actually in each class. Therefore, larger classes have more influence on the measure of model performance. Using this approach, the average AUC for <a href="#fig-voters-roc-curve" class="quarto-xref">Figure&nbsp;<span>13.4</span></a> is 0.627.</p>
</section><section id="multinomial-logistic-regression-in-r" class="level3" data-number="13.1.7"><h3 data-number="13.1.7" class="anchored" data-anchor-id="multinomial-logistic-regression-in-r">
<span class="header-section-number">13.1.7</span> Multinomial logistic regression in R</h3>
<p>Multinomial logistic models are fit using <code>multinom()</code> from the <strong>nnet</strong> R package <span class="citation" data-cites="nnet">(<a href="references.html#ref-nnet" role="doc-biblioref">Venables and Ripley 2002</a>)</span>.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># library(nnet) </span></span>
<span></span>
<span><span class="va">voter_fit</span> <span class="op">&lt;-</span> <span class="fu">multinom</span><span class="op">(</span><span class="va">voter_category</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">party_id</span>,</span>
<span>                      data <span class="op">=</span> <span class="va">voters</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># weights:  15 (8 variable)
initial  value 6411.501317 
iter  10 value 5881.210811
final  value 5858.219129 
converged</code></pre>
</div>
</div>
<p>The model output can be tidied and neatly displayed using <code>tidy()</code> from the <strong>broom</strong> package <span class="citation" data-cites="broom">(<a href="references.html#ref-broom" role="doc-biblioref">Robinson, Hayes, and Couch 2023</a>)</span> and <code>kable()</code> from the <strong>knitR</strong> package <span class="citation" data-cites="knitr">(<a href="references.html#ref-knitr" role="doc-biblioref">Xie 2024</a>)</span>.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tidy</span><span class="op">(</span><span class="va">voter_fit</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">kable</span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 13%">
<col style="width: 33%">
<col style="width: 13%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 11%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">y.level</th>
<th style="text-align: left;">term</th>
<th style="text-align: right;">estimate</th>
<th style="text-align: right;">std.error</th>
<th style="text-align: right;">statistic</th>
<th style="text-align: right;">p.value</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">sporadic</td>
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: right;">-1.046</td>
<td style="text-align: right;">0.116</td>
<td style="text-align: right;">-9.031</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">sporadic</td>
<td style="text-align: left;">age</td>
<td style="text-align: right;">0.041</td>
<td style="text-align: right;">0.002</td>
<td style="text-align: right;">18.834</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sporadic</td>
<td style="text-align: left;">party_idNo affiliation</td>
<td style="text-align: right;">-0.677</td>
<td style="text-align: right;">0.081</td>
<td style="text-align: right;">-8.389</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">sporadic</td>
<td style="text-align: left;">party_idRepublican</td>
<td style="text-align: right;">-0.106</td>
<td style="text-align: right;">0.095</td>
<td style="text-align: right;">-1.118</td>
<td style="text-align: right;">0.264</td>
</tr>
<tr class="odd">
<td style="text-align: left;">always</td>
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: right;">-1.983</td>
<td style="text-align: right;">0.131</td>
<td style="text-align: right;">-15.157</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">always</td>
<td style="text-align: left;">age</td>
<td style="text-align: right;">0.052</td>
<td style="text-align: right;">0.002</td>
<td style="text-align: right;">22.144</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">always</td>
<td style="text-align: left;">party_idNo affiliation</td>
<td style="text-align: right;">-0.872</td>
<td style="text-align: right;">0.089</td>
<td style="text-align: right;">-9.824</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">always</td>
<td style="text-align: left;">party_idRepublican</td>
<td style="text-align: right;">-0.091</td>
<td style="text-align: right;">0.101</td>
<td style="text-align: right;">-0.901</td>
<td style="text-align: right;">0.368</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="analysis_in_practice">
<p><strong>Suppress model fit messages</strong></p>
<p>The coefficients are estimated using numerical approximation methods to find the values that maximize the likelihood function. The <code>mulitnom</code> function will produce a message summarizing the optimization iterations. This information is generally not necessary in practice, so include the code chunk option <code>#| results:  hide</code> in Quarto documents to suppress the message.</p>
</div>
<p>Predictions from the multinomial model are computed using the <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> function. The argument <code>type = "probs"</code> produces a matrix of the predicted probabilities and <code>type = "class"</code> produces a vector of the predicted classes.</p>
<p>We add these to the original tibble for additional analysis.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># compute predicted probabilities</span></span>
<span><span class="va">voter_pred_prob</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">voter_fit</span>, type <span class="op">=</span> <span class="st">"probs"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># compute predicted class</span></span>
<span><span class="va">voter_pred_class</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">voter_fit</span>, type <span class="op">=</span> <span class="st">"class"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># add predictions to original tibble</span></span>
<span><span class="va">voters</span> <span class="op">&lt;-</span> <span class="va">voters</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">bind_cols</span><span class="op">(</span><span class="va">voter_pred_prob</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>pred_class <span class="op">=</span> <span class="va">voter_pred_class</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The syntax for the confusion matrix, ROC curves, and AUC are similar to logistic regression in <a href="12-logistic-prediction.html#sec-logistic-prediction-R" class="quarto-xref"><span>Section 12.6</span></a>.</p>
<p>The confusion matrix is produced using <code>conf_mat()</code> from the <strong>yardstick</strong> R package <span class="citation" data-cites="yardstick">(<a href="references.html#ref-yardstick" role="doc-biblioref">Kuhn, Vaughan, and Hvitfeldt 2025</a>)</span>. We use <code>autoplot()</code> to format the confusion matrix such that the cells are shaded by the number of observations.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">voters</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">conf_mat</span><span class="op">(</span><span class="va">voter_category</span>, <span class="va">pred_class</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">autoplot</span><span class="op">(</span>type <span class="op">=</span> <span class="st">"heatmap"</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><a href="13-special-topics_files/figure-html/unnamed-chunk-5-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8"><img src="13-special-topics_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" style="width:100.0%"></a></p>
</figure>
</div>
</div>
</div>
<p>The multiclass ROC curves are produced using <code>roc_curve()</code> in the <strong>yardstick</strong> R package <span class="citation" data-cites="yardstick">(<a href="references.html#ref-yardstick" role="doc-biblioref">Kuhn, Vaughan, and Hvitfeldt 2025</a>)</span>. The argument <code>truth =</code> specifies the columns with the observed classes, and the next line of code indicates the columns that contain the predicted probabilities. The <code>roc_curve()</code> function produces the data underlying the curves, and <code>autoplot()</code> produces the curves.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">voters</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">roc_curve</span><span class="op">(</span></span>
<span>    truth <span class="op">=</span> <span class="va">voter_category</span>, </span>
<span>    <span class="va">`rarely/never`</span><span class="op">:</span><span class="va">always</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">autoplot</span><span class="op">(</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><a href="13-special-topics_files/figure-html/unnamed-chunk-6-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-9"><img src="13-special-topics_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" style="width:100.0%"></a></p>
</figure>
</div>
</div>
</div>
<p>Lastly, the AUC is computed using <code>roc_auc()</code> from the <strong>yardstick</strong> R package. The the weighted average AUC is computed using the argument <code>estimator = "macro_weighted"</code>. The unweighted average AUC is computed by default.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># compute unweighted average AUC</span></span>
<span><span class="va">voters</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">roc_auc</span><span class="op">(</span></span>
<span>    truth <span class="op">=</span> <span class="va">voter_category</span>, </span>
<span>    <span class="va">`rarely/never`</span><span class="op">:</span><span class="va">always</span></span>
<span>  <span class="op">)</span> </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  .metric .estimator .estimate
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
1 roc_auc hand_till      0.656</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># compute weighted average AUC</span></span>
<span><span class="va">voters</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">roc_auc</span><span class="op">(</span></span>
<span>    truth <span class="op">=</span> <span class="va">voter_category</span>, </span>
<span>    <span class="va">`rarely/never`</span><span class="op">:</span><span class="va">always</span>,</span>
<span>    estimator <span class="op">=</span> <span class="st">"macro_weighted"</span></span>
<span>  <span class="op">)</span> </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  .metric .estimator     .estimate
  &lt;chr&gt;   &lt;chr&gt;              &lt;dbl&gt;
1 roc_auc macro_weighted     0.627</code></pre>
</div>
</div>
</section><section id="generalized-linear-models" class="level3" data-number="13.1.8"><h3 data-number="13.1.8" class="anchored" data-anchor-id="generalized-linear-models">
<span class="header-section-number">13.1.8</span> Generalized linear models</h3>
</section></section><section id="sec-random-intercepts" class="level2" data-number="13.2"><h2 data-number="13.2" class="anchored" data-anchor-id="sec-random-intercepts">
<span class="header-section-number">13.2</span> Random intercepts model</h2>
<p>One of the key assumptions we’ve made throughout this book is that the observations in the sample data are independent of each other. Often in practice, however, there is an underlying grouping structure in the data, and the observations are not completely independent of one another. For example, the data may contain multiple measurements from each individual (call repeated measures) as in <a href="#fig-repeated-measures" class="quarto-xref">Figure&nbsp;<span>13.5</span></a>.</p>
<div id="fig-repeated-measures" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-repeated-measures-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="images/13-repeated-measures-structure.png" class="lightbox" data-gallery="quarto-lightbox-gallery-10" title="Figure&nbsp;13.5: Repeated measures data structure"><img src="images/13-repeated-measures-structure.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-repeated-measures-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13.5: Repeated measures data structure
</figcaption></figure>
</div>
<p>Another common grouping structure is having multiple observations from within a single group, such that we expect the observations within the group to be more similar than observations from different groups, as in <a href="#fig-grouped-data-structure" class="quarto-xref">Figure&nbsp;<span>13.6</span></a>.</p>
<div id="fig-grouped-data-structure" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-grouped-data-structure-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="images/13-grouped-data-structure.png" class="lightbox" data-gallery="quarto-lightbox-gallery-11" title="Figure&nbsp;13.6: Grouped data structure"><img src="images/13-grouped-data-structure.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-grouped-data-structure-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13.6: Grouped data structure
</figcaption></figure>
</div>
<p>Data that contain a grouping structure are called <strong>multilevel data</strong>. The individual observations are at the first level of the data, and the groups are at the second level. We use <strong>generalized linear mixed models</strong> (GLMM), also called <em>multilevel models</em> or <em>hierarchical models</em>, to account for the grouping structure when we fit the model and conduct statistical inference. There are many types of generalized linear mixed models; in fact, there are often entire undergraduate-level courses dedicated to these models. In this section, we will introduce one of the most widely used GLMMs in practice, the random intercepts model.</p>
<section id="data-lemurs" class="level3" data-number="13.2.1"><h3 data-number="13.2.1" class="anchored" data-anchor-id="data-lemurs">
<span class="header-section-number">13.2.1</span> Data: Lemurs</h3>
<p>In <a href="07-mlr.html" class="quarto-xref"><span>Chapter 7</span></a>, we introduced a data set containing the weight, age, and other characteristics of lemurs living at the Duke Lemur Center. The data used in that chapter contained observations from a single weigh-in for each lemur between 0 and 24 months old. The lemurs were, in fact, weighed regularly, so the original data from <span class="citation" data-cites="tidytuesday">Community (<a href="references.html#ref-tidytuesday" role="doc-biblioref">2024</a>)</span> <!--# more specific citation?--> includes multiple measures for each lemur. The data in this section includes all the measurements for each lemur when they were 1 to 24 months old.</p>
<p>The data are in <code>lemurs-repeated-measures.csv</code>. We will use the following variables:</p>
<ul>
<li>
<code>weight</code>: Weight of the lemur (in grams)</li>
<li>
<code>taxon</code> : Code made as a combination of the lemur’s genus and species. Note that the genus is a broader categorization that includes lemurs from multiple species. <!--# is this note helpful or confusing?--> This analysis focuses on the following taxon:
<ul>
<li><p><code>ERUF</code>: Eulemur rufus, commonly known as Red-fronted brown lemur</p></li>
<li><p><code>PCOQ</code>: Propithecus coquereli, commonly known as Coquerel’s sifaka</p></li>
<li><p><code>VRUB</code>: Varecia rubra, commonly known as Red ruffed lemur</p></li>
</ul>
</li>
<li>
<code>sex</code> : Sex of lemur (<code>M</code>: Male, <code>F</code>: Female)</li>
<li>
<code>age</code>: Age of lemur when weight was recorded (in months)</li>
<li>
<code>litter_size</code>: Total number of infants in the litter the lemur was born into (this includes the observed lemur)</li>
</ul>
<p>See <span class="citation" data-cites="tidytuesday">Community (<a href="references.html#ref-tidytuesday" role="doc-biblioref">2024</a>)</span> for the full codebook. <!--# more specific reference?--></p>
<p>The goal of the analysis is to understand a lemur’s growth rate (relationship between age and weight) after adjusting for other characteristics.</p>
<div id="fig-lemur-structure" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-lemur-structure-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="images/13-lemurs-data-structure.png" class="lightbox" data-gallery="quarto-lightbox-gallery-12" title="Figure&nbsp;13.7: Structure of lemur data"><img src="images/13-lemurs-data-structure.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:100.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-lemur-structure-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13.7: Structure of lemur data
</figcaption></figure>
</div>
<p>The lemurs data set is an example of repeated measures, where the data are grouped by lemur as shown in <a href="#fig-lemur-structure" class="quarto-xref">Figure&nbsp;<span>13.7</span></a>. These data violate the independence assumption of linear regression models (<a href="08-mlr-inference.html#sec-mlr-conditions-diagnositics" class="quarto-xref"><span>Section 8.5</span></a>) and logistic regression models (<a href="11-logistic.html#sec-logistic-conditions" class="quarto-xref"><span>Section 11.6</span></a>), because we expected observations from a single lemur to be correlated with one another. Some factors (e.g., <code>taxon</code> ) will remain constant for all observations from an individual lemur. <a href="#tbl-individual-lemur" class="quarto-xref">Table&nbsp;<span>13.4</span></a> shows the data for an individual lemur.</p>
<div class="cell">
<div id="tbl-individual-lemur" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-individual-lemur-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;13.4: All observations from an individual lemur
</figcaption><div aria-describedby="tbl-individual-lemur-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead><tr class="header">
<th style="text-align: right;">dlc_id</th>
<th style="text-align: left;">name</th>
<th style="text-align: left;">taxon</th>
<th style="text-align: left;">sex</th>
<th style="text-align: right;">litter_size</th>
<th style="text-align: right;">age</th>
<th style="text-align: right;">weight</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">6492</td>
<td style="text-align: left;">MIRFAK</td>
<td style="text-align: left;">VRUB</td>
<td style="text-align: left;">M</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">1.32</td>
<td style="text-align: right;">590</td>
</tr>
<tr class="even">
<td style="text-align: right;">6492</td>
<td style="text-align: left;">MIRFAK</td>
<td style="text-align: left;">VRUB</td>
<td style="text-align: left;">M</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">8.22</td>
<td style="text-align: right;">2560</td>
</tr>
<tr class="odd">
<td style="text-align: right;">6492</td>
<td style="text-align: left;">MIRFAK</td>
<td style="text-align: left;">VRUB</td>
<td style="text-align: left;">M</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">10.06</td>
<td style="text-align: right;">2610</td>
</tr>
<tr class="even">
<td style="text-align: right;">6492</td>
<td style="text-align: left;">MIRFAK</td>
<td style="text-align: left;">VRUB</td>
<td style="text-align: left;">M</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">12.79</td>
<td style="text-align: right;">2800</td>
</tr>
<tr class="odd">
<td style="text-align: right;">6492</td>
<td style="text-align: left;">MIRFAK</td>
<td style="text-align: left;">VRUB</td>
<td style="text-align: left;">M</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">14.63</td>
<td style="text-align: right;">3160</td>
</tr>
<tr class="even">
<td style="text-align: right;">6492</td>
<td style="text-align: left;">MIRFAK</td>
<td style="text-align: left;">VRUB</td>
<td style="text-align: left;">M</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">16.47</td>
<td style="text-align: right;">3020</td>
</tr>
<tr class="odd">
<td style="text-align: right;">6492</td>
<td style="text-align: left;">MIRFAK</td>
<td style="text-align: left;">VRUB</td>
<td style="text-align: left;">M</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">18.84</td>
<td style="text-align: right;">3340</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>In this data, the lemur’s <code>dlc_id</code>, <code>name</code>, <code>sex</code>, <code>taxon</code>, and <code>litter_size</code> remain the same for its observations. These variables are at level two of the data, i.e., they differ between lemurs but are the same for all observations from an individual lemur. The <code>age</code> and <code>weight</code> are different across observations. These are variables at level one, because they change each time data are collected.</p>
<p>The data set contains seven observations for the lemur Mirfak in <a href="#tbl-individual-lemur" class="quarto-xref">Table&nbsp;<span>13.4</span></a> , but there are not necessarily seven observations for every lemur in the data. The number of observations for each lemur range from as few as 1 to as many as 120. The GLMMs can account for the different number of observations from each individual. When we fit the model, lemurs with more observations will be weighted more heavily when estimating the coefficients.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-lemurs-weight" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-lemurs-weight-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="13-special-topics_files/figure-html/fig-lemurs-weight-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-13" title="Figure&nbsp;13.8: weight versus age for nine lemurs"><img src="13-special-topics_files/figure-html/fig-lemurs-weight-1.png" class="img-fluid figure-img" style="width:100.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-lemurs-weight-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13.8: <code>weight</code> versus <code>age</code> for nine lemurs
</figcaption></figure>
</div>
</div>
</div>
<p>Now let’s take a look at the relationship between <code>weight</code> and <code>age</code> for the lemurs in the data. <a href="#fig-lemurs-weight" class="quarto-xref">Figure&nbsp;<span>13.8</span></a> shows the relationship between these variables for a sample of nine lemurs. The figure illustrates how the number of observations differ for each lemur. We can also begin to see how the weight changes with age for the lemurs. The visualizations of these 9 lemurs give us an idea of the variation in the data, but we would like to visualize the relationship for all the lemurs in the data. To do so, we use a <strong>spaghetti plot</strong>, shown in <a href="#fig-lemurs-spaghetti-plot" class="quarto-xref">Figure&nbsp;<span>13.9</span></a>.</p>
<div class="cell" data-fig-label="Spaghetti plot of lemurs weight versus age">
<div class="cell-output-display">
<div id="fig-lemurs-spaghetti-plot" class="quarto-float quarto-figure quarto-figure-center anchored" width="100%">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-lemurs-spaghetti-plot-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="13-special-topics_files/figure-html/fig-lemurs-spaghetti-plot-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-14" title="Figure&nbsp;13.9: "><img src="13-special-topics_files/figure-html/fig-lemurs-spaghetti-plot-1.png" id="fig-lemurs-spaghetti-plot" class="img-fluid figure-img" style="width:100.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-lemurs-spaghetti-plot-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13.9
</figcaption></figure>
</div>
</div>
</div>
<p>The gray lines in <a href="#fig-lemurs-spaghetti-plot" class="quarto-xref">Figure&nbsp;<span>13.9</span></a> are the relationships between age and weight for each of the 248 lemurs in the data set. The blue line is the average trajectory across all the lemurs. From this plot, we more easily see the difference in the growth rate for the lemurs by the different slopes of the relationship between age and weight. We can also see the general differences in weight across the lemurs at each age.</p>
<p>The linear regression (and logistic regression) models we’ve seen thus have a single intercept for all observations. In other words, if we fit a model using age to predict weight, there would be a single intercept for the expected weight for new born lemurs. From <a href="#fig-lemurs-spaghetti-plot" class="quarto-xref">Figure&nbsp;<span>13.9</span></a>, we see that the lemurs are generally different weights (even lemurs with the same age and taxon), so a single intercept may not best represent the trend in the data We will use a random intercepts model to account for this additional variability.<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></p>
</section><section id="model-fit-and-interpretation" class="level3" data-number="13.2.2"><h3 data-number="13.2.2" class="anchored" data-anchor-id="model-fit-and-interpretation">
<span class="header-section-number">13.2.2</span> Model fit and interpretation</h3>
<p>GLMMs differ from the GLMs we’ve studied thus far, because they include both fixed and random effects. The <strong>fixed effects</strong> are the variables we are interested in studying or explicitly adjusting for in the model. These are the variables for which we want to obtain an estimated coefficient. In the lemurs analysis, the fixed effects are <code>age</code>, <code>taxon</code>, <code>sex</code>, and <code>litter_size</code>. The <strong>random effects</strong> are those we don’t want to estimate explicitly but whose variability we want to understand. These are generally defined by the grouping variable in the data. In this analysis, the random effect is the individual lemur, captured by the variable <code>dlc_id</code>.</p>
<p>The <strong>random intercepts model</strong> includes fixed and random effects, such that the random effects account for random variability in the intercept. The general form of the model is <!--# think about how to write this./ do i need it?--></p>
<p>Let <span class="math inline">\(\text{weight}_{ij}\)</span> be the weight in the <span class="math inline">\(j^{th}\)</span> observation for lemur <span class="math inline">\(i\)</span>. Then, the random intercepts model for the lemurs analysis is</p>
<p><span id="eq-lemurs-random-int"><span class="math display">\[
\begin{aligned}
\text{weight}_{ij} = \beta_0 &amp;+ \beta_1 ~ \text{taxonPCOQ}_{i} + \beta_2 ~ \text{taxonVRUB}_i \\
&amp; +\beta_3 ~ \text{sexM}_{i}  + \beta_4 ~ \text{litter\_size}_{i} + \beta_5 ~ \text{age}_{ij}\\
&amp; + u_i + \epsilon_{ij} \\
&amp;u_i \sim N(0, \sigma^2_{u}) \hspace{5mm} \epsilon_{ij} \sim N(0, \sigma^2_{\epsilon})
\end{aligned}
\tag{13.4}\]</span></span></p>
<p>Let’s break down the components of <a href="#eq-lemurs-random-int" class="quarto-xref">Equation&nbsp;<span>13.4</span></a>. The subscript indicate whether the variable is at the first or second level of the data. The variable <code>age</code> is the only predictor in the second level that changes for each observation, so the subscript indicates that we plug in the age for lemur <span class="math inline">\(i\)</span> at the <span class="math inline">\(j^{th}\)</span> observation. The other predictors are measured at the second level of the data, so the subscript <span class="math inline">\(i\)</span> indicates that we plug in the same value for lemur <span class="math inline">\(i\)</span> across all its observations. The term <span class="math inline">\(\beta_0\)</span> is the global intercept. It is the expected (mean) weight across all lemurs when all predictors are equal to 0.</p>
<p>The error term <span class="math inline">\(\epsilon_{ij}\)</span> is like the error term previously introduced for linear models. It is the difference between the observed and expected value of the weight for the <span class="math inline">\(j^{th}\)</span> observation from lemur <span class="math inline">\(i\)</span>. As in linear regression, these error terms follow a normal distribution with mean of 0 and variance of <span class="math inline">\(\sigma^2_{\epsilon}\)</span>. This <span class="math inline">\(\sigma^2_{\epsilon}\)</span> is a measure of the variability in the weights (response variable) within an individual lemur (group).</p>
<p>The term <span class="math inline">\(u_{i}\)</span> is the random effect that makes this the “random intercepts model”. We don’t estimate <span class="math inline">\(u_i\)</span> directly, but its distribution tells us about the variability in the average weights between lemurs. The <span class="math inline">\(u_{i}\)</span> are normally distributed with a mean of 0 and variance of <span class="math inline">\(\sigma^2_{u}\)</span>. This <span class="math inline">\(\sigma^2_{u}\)</span> is the measure of between lemur variability. From this model, the intercept of an individual lemur <span class="math inline">\(i\)</span> is <span class="math inline">\(\beta_0 + u_i\)</span> where, <span class="math inline">\(u_i\)</span> is drawn from <span class="math inline">\(N(0,\sigma^2_{u})\)</span>.</p>
<p>The coefficients <span class="math inline">\(\beta_0, \beta_1, \ldots, \beta_5\)</span> and the variance components <span class="math inline">\(\sigma_u\)</span> and <span class="math inline">\(\sigma_{\epsilon}\)</span> are estimated using maximum likelihood estimation. The output for the lemurs random intercepts model is in <a href="#tbl-lemurs-model-random-int" class="quarto-xref">Table&nbsp;<span>13.5</span></a>.</p>
<div class="cell">
<div id="tbl-lemurs-model-random-int" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-lemurs-model-random-int-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;13.5: Random intercepts model for lemurs data
</figcaption><div aria-describedby="tbl-lemurs-model-random-int-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead><tr class="header">
<th style="text-align: left;">effect</th>
<th style="text-align: left;">group</th>
<th style="text-align: left;">term</th>
<th style="text-align: right;">estimate</th>
<th style="text-align: right;">std.error</th>
<th style="text-align: right;">statistic</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">fixed</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: right;">16.0</td>
<td style="text-align: right;">79.07</td>
<td style="text-align: right;">0.202</td>
</tr>
<tr class="even">
<td style="text-align: left;">fixed</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">taxonPCOQ</td>
<td style="text-align: right;">449.9</td>
<td style="text-align: right;">67.12</td>
<td style="text-align: right;">6.703</td>
</tr>
<tr class="odd">
<td style="text-align: left;">fixed</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">taxonVRUB</td>
<td style="text-align: right;">1021.4</td>
<td style="text-align: right;">94.48</td>
<td style="text-align: right;">10.811</td>
</tr>
<tr class="even">
<td style="text-align: left;">fixed</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">sexM</td>
<td style="text-align: right;">-27.1</td>
<td style="text-align: right;">45.22</td>
<td style="text-align: right;">-0.599</td>
</tr>
<tr class="odd">
<td style="text-align: left;">fixed</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">litter_size</td>
<td style="text-align: right;">-66.8</td>
<td style="text-align: right;">45.14</td>
<td style="text-align: right;">-1.479</td>
</tr>
<tr class="even">
<td style="text-align: left;">fixed</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">age</td>
<td style="text-align: right;">147.7</td>
<td style="text-align: right;">0.97</td>
<td style="text-align: right;">152.338</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ran_pars</td>
<td style="text-align: left;">dlc_id</td>
<td style="text-align: left;">sd__(Intercept)</td>
<td style="text-align: right;">311.5</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">ran_pars</td>
<td style="text-align: left;">Residual</td>
<td style="text-align: left;">sd__Observation</td>
<td style="text-align: right;">356.3</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>The equation of the fitted model is</p>
<p><span class="math display">\[
\begin{aligned}
\widehat{\text{weight}}_{ij} = 15.969 &amp;+  449.932 ~ \text{taxonPOQ} +  1021.387 ~ \text{taxonVRUB} \\
&amp;  -27.073 ~ \text{sexM} - 66.771 ~ \text{litter\_size} + 147.719 ~ \text{age} \\
&amp;\hat{\sigma}_u = 311.504 \hspace{5mm} \hat{\sigma}_\epsilon = 356.275
\end{aligned}
\]</span></p>
<div class="yourturn">
<p>Use the model in <a href="#tbl-lemurs-model-random-int" class="quarto-xref">Table&nbsp;<span>13.5</span></a>.</p>
<ul>
<li><p>Interpret the coefficient of <code>age</code> in the context of the data.</p></li>
<li><p>Explain what <span class="math inline">\(\hat{\sigma}_u = 311.504\)</span> means in the context of the data.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a></p></li>
</ul>
</div>
</section><section id="random-intercepts-model-in-r" class="level3" data-number="13.2.3"><h3 data-number="13.2.3" class="anchored" data-anchor-id="random-intercepts-model-in-r">
<span class="header-section-number">13.2.3</span> Random intercepts model in R</h3>
<p>Random intercepts models are fit using the <code>lmer</code> function in the <code>lme4</code> R package <span class="citation" data-cites="lme4">(<a href="references.html#ref-lme4" role="doc-biblioref">Bates et al. 2015</a>)</span>. The syntax for the response and predictor variables is the same as in <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code>. The grouping variable is specified using the syntax <code>(1|grouping_var)</code>. This specifies that the random intercepts are based on <code>grouping_var</code>. The syntax for the model in <a href="#tbl-lemurs-model-random-int" class="quarto-xref">Table&nbsp;<span>13.5</span></a> is below.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">lemurs_fit</span> <span class="op">&lt;-</span> <span class="fu">lmer</span><span class="op">(</span><span class="va">weight</span> <span class="op">~</span> <span class="va">taxon</span> <span class="op">+</span> <span class="va">sex</span> <span class="op">+</span> <span class="va">litter_size</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> </span>
<span>                     <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">dlc_id</span><span class="op">)</span>, </span>
<span>                   data <span class="op">=</span> <span class="va">lemurs</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lemurs_fit</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: weight ~ taxon + sex + litter_size + age + (1 | dlc_id)
   Data: lemurs
REML criterion at convergence: 54636
Random effects:
 Groups   Name        Std.Dev.
 dlc_id   (Intercept) 312     
 Residual             356     
Number of obs: 3715, groups:  dlc_id, 248
Fixed Effects:
(Intercept)    taxonPCOQ    taxonVRUB         sexM  litter_size          age  
       16.0        449.9       1021.4        -27.1        -66.8        147.7  </code></pre>
</div>
</div>
<p>The results can be displayed in a tidy format using <code>tidy</code> function in the <strong>broom.mixed</strong> R package <span class="citation" data-cites="broom.mixed">(<a href="references.html#ref-broom.mixed" role="doc-biblioref">Bolker and Robinson 2024</a>)</span>. The results below are neatly displayed using <code>kable()</code>.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">tidy</span><span class="op">(</span><span class="va">lemurs_fit</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">kable</span><span class="op">(</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead><tr class="header">
<th style="text-align: left;">effect</th>
<th style="text-align: left;">group</th>
<th style="text-align: left;">term</th>
<th style="text-align: right;">estimate</th>
<th style="text-align: right;">std.error</th>
<th style="text-align: right;">statistic</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">fixed</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: right;">16.0</td>
<td style="text-align: right;">79.07</td>
<td style="text-align: right;">0.202</td>
</tr>
<tr class="even">
<td style="text-align: left;">fixed</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">taxonPCOQ</td>
<td style="text-align: right;">449.9</td>
<td style="text-align: right;">67.12</td>
<td style="text-align: right;">6.703</td>
</tr>
<tr class="odd">
<td style="text-align: left;">fixed</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">taxonVRUB</td>
<td style="text-align: right;">1021.4</td>
<td style="text-align: right;">94.48</td>
<td style="text-align: right;">10.811</td>
</tr>
<tr class="even">
<td style="text-align: left;">fixed</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">sexM</td>
<td style="text-align: right;">-27.1</td>
<td style="text-align: right;">45.22</td>
<td style="text-align: right;">-0.599</td>
</tr>
<tr class="odd">
<td style="text-align: left;">fixed</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">litter_size</td>
<td style="text-align: right;">-66.8</td>
<td style="text-align: right;">45.14</td>
<td style="text-align: right;">-1.479</td>
</tr>
<tr class="even">
<td style="text-align: left;">fixed</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">age</td>
<td style="text-align: right;">147.7</td>
<td style="text-align: right;">0.97</td>
<td style="text-align: right;">152.338</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ran_pars</td>
<td style="text-align: left;">dlc_id</td>
<td style="text-align: left;">sd__(Intercept)</td>
<td style="text-align: right;">311.5</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">ran_pars</td>
<td style="text-align: left;">Residual</td>
<td style="text-align: left;">sd__Observation</td>
<td style="text-align: right;">356.3</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
</tbody>
</table>
</div>
</div>
</section><section id="further-reading" class="level3" data-number="13.2.4"><h3 data-number="13.2.4" class="anchored" data-anchor-id="further-reading">
<span class="header-section-number">13.2.4</span> Further reading</h3>
<p>We have just scratched the surface in this section, but there are many resources for readers interested in learning more about random intercepts models and other types of GLMMs. See <em>Beyond Multiple Linear Regression</em> <span class="citation" data-cites="roback2021beyond">(<a href="references.html#ref-roback2021beyond" role="doc-biblioref">Roback and Legler 2021</a>)</span> and <em>Data Analysis Using Regression and Multilevel/Hierarchical Models</em> <span class="citation" data-cites="gelman2007data">(<a href="references.html#ref-gelman2007data" role="doc-biblioref">Gelman and Hill 2007</a>)</span> for an in-depth introduction to these topics.</p>
</section></section><section id="sec-decision-trees" class="level2" data-number="13.3"><h2 data-number="13.3" class="anchored" data-anchor-id="sec-decision-trees">
<span class="header-section-number">13.3</span> Decision trees</h2>
<p>The models presented in this book thus far have been parametric methods, in which we specify a form of the model then estimate the parameters of that model (<a href="01-intro.html#sec-what-is-regression" class="quarto-xref"><span>Section 1.1.1</span></a>). An alternative to this approach are tree-based models, a set of non-parametric methods that split the data based on a series of decision points. These methods are particularly useful if a precise interpretation of the relationship between the response and predictor variables is not needed, but rather a general understanding how to use the predictors to estimate the response is sufficient.</p>
<p>In the book <em>Introduction to Statistical Learning 2nd edition, <span class="citation" data-cites="james2021introduction">James et al. (<a href="references.html#ref-james2021introduction" role="doc-biblioref">2021</a>)</span></em> [pp.&nbsp;339] lists advantages of tree-based models compared to GLMs.</p>
<blockquote class="blockquote">
<ul>
<li>They are easier for others to understand;</li>
<li>They are believed to better mirror the human decision-making process;</li>
<li>They can more easily represented visually, making it easier for non-experts to understand them;</li>
<li>They can use categorical predictors without creating indicator variables.</li>
</ul>
</blockquote>
<p>This list could be summarized as “The key advantage to tree-based models is that they are easy for others, especially non-experts, to understand.” Here we introduce two tree-based models: regression trees for quantitative response variables and classification trees for categorical response variables.</p>
<section id="sec-regression-trees" class="level3" data-number="13.3.1"><h3 data-number="13.3.1" class="anchored" data-anchor-id="sec-regression-trees">
<span class="header-section-number">13.3.1</span> Regression trees</h3>
<p>Regression trees are decision trees to model data with quantitative response variables, so they are often an alternative to linear regression. The general idea is to use the predictor variables to split the data into groups of similar observations. For each observation, the predicted value of the response is computed as the mean response among the observations in its group. To illustrate this, let’s go back to the total expenditure on basketball programs for Division I NCAA institutions introduced in <a href="09-mlr-transformations.html" class="quarto-xref"><span>Chapter 9</span></a>. We will use a regression tree to predict <code>expenditure_m</code> (total expenditure in millions of dollars) using <code>type</code> (private or public institution), <code>region</code> (North Central, Northeast, South, West), and <code>enrollment_th</code> (total student enrollment in thousands).</p>
<div id="fig-ncaa-expenditure" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-ncaa-expenditure-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-ncaa-expenditure" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-ncaa-expenditure-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-ncaa-expenditure-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="13-special-topics_files/figure-html/fig-ncaa-expenditure-1.png" class="lightbox" data-gallery="fig-ncaa-expenditure" title="Figure&nbsp;13.10&nbsp;(a): Original expenditure_m"><img src="13-special-topics_files/figure-html/fig-ncaa-expenditure-1.png" class="img-fluid figure-img" style="width:100.0%" data-ref-parent="fig-ncaa-expenditure"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-ncaa-expenditure-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Original <code>expenditure_m</code>
</figcaption></figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-ncaa-expenditure" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-ncaa-expenditure-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-ncaa-expenditure-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="13-special-topics_files/figure-html/fig-ncaa-expenditure-2.png" class="lightbox" data-gallery="fig-ncaa-expenditure" title="Figure&nbsp;13.10&nbsp;(b): Log-transformed expenditure_m"><img src="13-special-topics_files/figure-html/fig-ncaa-expenditure-2.png" class="img-fluid figure-img" style="width:100.0%" data-ref-parent="fig-ncaa-expenditure"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-ncaa-expenditure-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Log-transformed <code>expenditure_m</code>
</figcaption></figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ncaa-expenditure-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13.10: Distribution of original and log-transformed <code>expenditure_m</code>
</figcaption></figure>
</div>
<p>The distribution of <code>expenditure_m</code> is heavily right-skewed <a href="#fig-ncaa-expenditure-1" class="quarto-xref">Figure&nbsp;<span>13.10 (a)</span></a>, so we will use the log-transformed variable <code>log(expenditure_m)</code> in the model <a href="#fig-ncaa-expenditure-2" class="quarto-xref">Figure&nbsp;<span>13.10 (b)</span></a>.</p>
<div class="analysis_in_practice">
<p>When the response variable is strongly skewed, it is good practice to use the transformed version in the regression tree. Though regression trees do not rely on the same assumptions as linear regression, their results can be strongly influenced by extreme observations when the distribution of the response variable is heavily skewed. Predictor variables do not need to be transformed for regression trees, because the tree does not depend on a linear relationship between the response and predictor variables.</p>
</div>
<p>A regression tree is made up of a series of nodes (also called <em>leaves</em>) and branches. The <strong>nodes</strong> are the decision-making points at each split (e.g., <code>enrollment_th &lt; 10?</code>). The <strong>branches</strong> connect two nodes (e.g, <code>enrollment_th &lt; 10 = TRUE</code> and <code>enrollment_th &lt; 10 = FALSE</code>). The <strong>terminal nodes</strong> are the points at the end of the tree where the data are no longer split and the predictions are made. The prediction is the mean value of the response variable for the observations in that node.</p>
<p>At each step, the model searches to find the variable and associated cut point that minimizes the sum of squares residual (SSR) in <a href="#eq-tree-ssr" class="quarto-xref">Equation&nbsp;<span>13.5</span></a>. This is the same SSR introduced in <a href="04-slr.html#sec-slr-sum-sq" class="quarto-xref"><span>Section 4.7.2</span></a>. Minimizing SSR maximizes the similarity of observations within a node. This process continues until making a new split no longer minimizes the SSR.</p>
<p><span id="eq-tree-ssr"><span class="math display">\[
SSR = \sum_{i = 1}^n(y_i - \hat{y}_i)^2
\tag{13.5}\]</span></span></p>
<p>Now let’s fit the regression tree to predict <code>expenditure_m</code> using <code>enrollment_th</code>, <code>region</code>, and <code>type</code>. Because the primary objective for the tree is prediction, we split the data into training (80%) and testing (20%) sets (<a href="10-model-eval.html#sec-training-testing" class="quarto-xref"><span>Section 10.4</span></a>). This will give us an assessment on how well the model performs on new data.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-ncaa-tree" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-ncaa-tree-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="13-special-topics_files/figure-html/fig-ncaa-tree-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-17" title="Figure&nbsp;13.11: Regression tree predicting NCAA basketball expenditure"><img src="13-special-topics_files/figure-html/fig-ncaa-tree-1.png" class="img-fluid figure-img" style="width:100.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ncaa-tree-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13.11: Regression tree predicting NCAA basketball expenditure
</figcaption></figure>
</div>
</div>
</div>
<p><a href="#fig-ncaa-tree" class="quarto-xref">Figure&nbsp;<span>13.11</span></a> is the output of the regression tree. In this output, we see the variables and associated cutpoint used to make the split at each step, along with the percentage of observations in each subsequent node. This output also shows the predicted <code>expenditure_m</code> in each node.</p>
<p>For example, the first split is whether <code>enrollment_th &lt; 12</code>. About 62% of the observations in the training data have <code>enrollment_th &lt; 12</code>, and the mean log(expenditure) for those observations is 1.5 million. In contrast, about 38% of the observations have <code>enrollment_th &gt;= 12</code>, and the mean log(expenditure) for those observations is about 2.4 million. If we were to stop there, then 1.5 million would be the predicted log(expenditure) for all observations with <code>enrollment &lt; 12</code> and 2.4 million would be the predicted log(expenditure) for all other observations.</p>
<p>Let’s use the tree to find the predicted expenditure for a private institution in the South region that has enrollment of 6,000 students. At the first step, we go down the “Yes” branch for <code>enrollment_th &lt; 12</code>. Next, we go down the “No” branch for <code>type = Public</code>. Next, we go down the “No” branch for <code>enrollment_th &lt; 4.1</code>. Next, we go down the branch, “No” for <code>region = Northeast</code>. Lastly, we go down the “Yes” branch for <code>enrollment_th &lt; 6.3</code>. This branch leads to the terminal node of <span class="math inline">\(\widehat{\log(\text{expenditure\_m})} = 2.2\)</span>, which is equal to a predicted expenditure of 9.025 (<span class="math inline">\(e^{2.2}\)</span>) million dollars.</p>
<div class="yourturn">
<p>What is the predicted expenditure for a public institution in the West region with enrollment of 20,000 students.<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a></p>
</div>
<p>We evaluate the model’s performance using the testing data. We compute the predicted expenditures for the observations in the testing data the root mean square error (RSME), introduced in <a href="04-slr.html#sec-model-assessment" class="quarto-xref"><span>Section 4.7</span></a>, as a measure of the model performance.</p>
<p>The RMSE for the testing data is 0.506. This is the terms of the response variable, <code>log(expenditure_m)</code>, so the error in terms of the original variable is 1.659. This means that the average difference between the observed expenditure and predicted is 1.659 million dollars.</p>
</section><section id="sec-classification-trees" class="level3" data-number="13.3.2"><h3 data-number="13.3.2" class="anchored" data-anchor-id="sec-classification-trees">
<span class="header-section-number">13.3.2</span> Classification trees</h3>
<p>Classification trees are decision trees for predicting categorical outcomes. We might use such a tree as an alternative to logistic regression <a href="11-logistic.html" class="quarto-xref"><span>Chapter 11</span></a> or multinomial logistic regression <a href="#sec-multinomial" class="quarto-xref"><span>Section 13.1</span></a>. They are very similar to regression trees with two primary differences. The first is that predictions in the <strong>terminal nodes</strong> are the predicted classes. The second is that the potential variables and associated cutoffs to define each split are evaluated using different criteria. The default in most software is the <strong>Gini Index</strong> shown in <a href="#eq-gini-index" class="quarto-xref">Equation&nbsp;<span>13.6</span></a></p>
<p><span id="eq-gini-index"><span class="math display">\[
\text{Gini index} = 1 - \sum_{k = 1}^K p_{mk}^2
\tag{13.6}\]</span></span></p>
<p>where <span class="math inline">\(p_{mk}\)</span> is the proportion of observations in the <span class="math inline">\(m^{th}\)</span> node that belong to class <span class="math inline">\(k\)</span>. Similar to RSS, the model selects the variable and cutoff that minimizes the Gini index at each step. Low values of the Gini index indicate a large proportion of observations in a given node are from the same class.</p>
<p>Let’s go back to the voter frequency data introduced in <a href="#sec-voters-data" class="quarto-xref"><span>Section 13.1.1</span></a>. We’ll use a classification tree to predict the <code>voter_category</code> (<code>rarely/never</code>, <code>sporadic</code>, <code>always</code>) using <code>age</code>, <code>party_id</code>, and an additional variable <code>income_cat</code>. We split the data into training (80%) and testing sets (20%), so we can evaluate the model’s performance on new data.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-voters-tree" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-voters-tree-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="13-special-topics_files/figure-html/fig-voters-tree-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-18" title="Figure&nbsp;13.12: Classification tree voter frequency"><img src="13-special-topics_files/figure-html/fig-voters-tree-1.png" class="img-fluid figure-img" style="width:100.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-voters-tree-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13.12: Classification tree voter frequency
</figcaption></figure>
</div>
</div>
</div>
<p><a href="#fig-voters-tree" class="quarto-xref">Figure&nbsp;<span>13.12</span></a> is the output from the classification tree. Something that may stand out is that the predictor <code>party_id</code> is not used in the tree. This means there was never a point where using <code>party_id</code> was more useful in classifying observations compared to the other predictors.</p>
<p>The first split in <a href="#fig-voters-tree" class="quarto-xref">Figure&nbsp;<span>13.12</span></a> is at <code>age &lt; 34</code>. About 21% of the observations have <code>age &lt; 34</code>, and this group leads to a terminal node. Among those with <code>age &lt; 34</code>, 34% of them are classified as <code>rarely/never</code>, 21% are classified as <code>sporadic</code>, and 30% are classified as <code>always</code> in the data. Therefore, if <code>age &lt; 34</code>, the predicted class is <code>rarely/never</code> based on the classification tree. There is a bit more work among those with <code>age &gt;= 34</code>. The next split is <code>age &lt; 61</code>. If <code>age &lt; 61</code>, then there is a terminal node with the predicted class <code>sporadic</code>. Otherwise, <code>income_cat</code> is taken into account, with a split at <code>income_cat = Less than $40k</code>. If yes, then the predicted class is <code>sporadic</code>; if no, the predicted class is <code>always</code>.</p>
<div class="yourturn">
<p>Based on <a href="#fig-voters-tree" class="quarto-xref">Figure&nbsp;<span>13.12</span></a>, what is the predicted voting frequency for an a 40 year old individual whose party affiliation is Democrat and annual income is $70,000?<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a></p>
</div>
</section><section id="decision-trees-in-r" class="level3" data-number="13.3.3"><h3 data-number="13.3.3" class="anchored" data-anchor-id="decision-trees-in-r">
<span class="header-section-number">13.3.3</span> Decision trees in R</h3>
<p>We fit decision trees using the <code>rpart()</code> function in the <strong>rpart</strong> R package <span class="citation" data-cites="rpart">(<a href="references.html#ref-rpart" role="doc-biblioref">Therneau and Atkinson 2025</a>)</span>. The argument <code>method =</code> is used to specify the type of decision tree.</p>
<p>Below is the code for the regression tree fit in <a href="#sec-regression-trees" class="quarto-xref"><span>Section 13.3.1</span></a>. The argument <code>method = "anova"</code> specifies that we are fitting a regression tree. If we type the name of the tree, we see a summary of the nodes and branches</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ncaa_tree</span> <span class="op">&lt;-</span> <span class="fu">rpart</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">expenditure_m</span><span class="op">)</span> <span class="op">~</span> <span class="va">enrollment_th</span> <span class="op">+</span> </span>
<span>                     <span class="va">type</span> <span class="op">+</span> <span class="va">region</span>,</span>
<span>                   data <span class="op">=</span> <span class="va">ncaa_train</span>,</span>
<span>                   method <span class="op">=</span> <span class="st">"anova"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ncaa_tree</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>n= 284 

node), split, n, deviance, yval
      * denotes terminal node

 1) root 284 165.00 1.840  
   2) enrollment_th&lt; 11.7 176  65.20 1.510  
     4) type=Public 95  15.90 1.240  
       8) enrollment_th&lt; 4.35 22   2.32 0.821 *
       9) enrollment_th&gt;=4.35 73   8.64 1.360 *
     5) type=Private 81  34.30 1.820  
      10) enrollment_th&lt; 4.06 40   5.41 1.500 *
      11) enrollment_th&gt;=4.06 41  20.70 2.140  
        22) region=Northeast 18   5.53 1.650 *
        23) region=North Central,South,West 23   7.60 2.520  
          46) enrollment_th&lt; 6.32 12   2.62 2.180 *
          47) enrollment_th&gt;=6.32 11   2.13 2.880 *
   3) enrollment_th&gt;=11.7 108  49.30 2.370  
     6) enrollment_th&lt; 31.5 96  42.70 2.290  
      12) enrollment_th&lt; 18.1 38  15.10 2.080  
        24) region=North Central,Northeast,West 20   4.98 1.880 *
        25) region=South 18   8.42 2.300 *
      13) enrollment_th&gt;=18.1 58  24.70 2.440  
        26) region=West 19   7.67 2.090 *
        27) region=North Central,Northeast,South 39  13.60 2.610 *
     7) enrollment_th&gt;=31.5 12   1.09 3.010 *</code></pre>
</div>
</div>
<p>The code below is the classification tree from <a href="#sec-classification-trees" class="quarto-xref"><span>Section 13.3.2</span></a>. We use the argument <code>method = "class"</code> to specify the classification tree. Similar to regression trees, we can type the name of the tree to see a summary of the nodes and branches.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">voters_tree</span> <span class="op">&lt;-</span> <span class="fu">rpart</span><span class="op">(</span><span class="va">voter_category</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">party_id</span> <span class="op">+</span></span>
<span>                       <span class="va">income_cat</span> <span class="op">+</span> <span class="va">educ</span>, </span>
<span>                   data <span class="op">=</span> <span class="va">voters_train</span>, </span>
<span>                   method <span class="op">=</span> <span class="st">"class"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">voters_tree</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>n= 4668 

node), split, n, loss, yval, (yprob)
      * denotes terminal node

 1) root 4668 2590 sporadic (0.2509 0.4460 0.3031)  
   2) age&lt; 33.5 973  495 rarely/never (0.4913 0.2127 0.2960) *
   3) age&gt;=33.5 3695 1820 sporadic (0.1876 0.5074 0.3050)  
     6) age&lt; 60.5 2017  879 sporadic (0.2558 0.5642 0.1800) *
     7) age&gt;=60.5 1678  914 always (0.1055 0.4392 0.4553)  
      14) income_cat=Less than $40k 452  223 sporadic (0.1770 0.5066 0.3164) *
      15) income_cat=$125k or more,$40-75k,$75-125k 1226  605 always (0.0791 0.4144 0.5065) *</code></pre>
</div>
</div>
<p>The summaries produced by <code>rpart()</code> are challenging to read, so we use the <code>rpart.plot()</code> from the <strong>rpart.plot</strong> R package <span class="citation" data-cites="rpart.plot">(<a href="references.html#ref-rpart.plot" role="doc-biblioref">Milborrow 2025</a>)</span> to create a visual representation of the tree. The code below produces the visualization of the regression tree for NCAA basketball expenditures.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">rpart.plot</span><span class="op">(</span><span class="va">ncaa_tree</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><a href="13-special-topics_files/figure-html/unnamed-chunk-13-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-19"><img src="13-special-topics_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" style="width:100.0%"></a></p>
</figure>
</div>
</div>
</div>
<p>Predictions are produced using <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code>. This will produce a vector of predictions that can be added to the original data frame to evaluate model performance.</p>
<p>The code below produces the predictions for the testing data from the regression tree predicting NCAA basketball expenditures and saves the predictions as a column in the testing data. The same code is used to produce predictions from the classification tree.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ncaa_test</span> <span class="op">&lt;-</span> <span class="va">ncaa_test</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>predict_expend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">ncaa_tree</span>, <span class="va">ncaa_test</span><span class="op">)</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The predictions are in the same units as the response variable, so in this case, the predicted values are the predicted <code>log(expenditure_m)</code>.</p>
</section><section id="further-reading-1" class="level3" data-number="13.3.4"><h3 data-number="13.3.4" class="anchored" data-anchor-id="further-reading-1">
<span class="header-section-number">13.3.4</span> Further reading</h3>
<p>Overall, decision trees can be a nice alternative to linear and logistic regression. Their greatest advantage is that they can be easily represented visually and thus easier for non-experts to understand. The two greatest disadvantages to these models, however, are the inferior predictive accuracy compared to other modeling approaches and their sensitivity to small changes in the data <span class="citation" data-cites="james2021introduction">(<a href="references.html#ref-james2021introduction" role="doc-biblioref">James et al. 2021, 340</a>)</span>. In this section, we introduced decision trees, but there is extensive work in tuning (customizing) these models along with more advanced models that take into account multiple trees (e.g., random forest). We refer the reader to Chapter 8 <span class="citation" data-cites="james2021introduction">James et al. (<a href="references.html#ref-james2021introduction" role="doc-biblioref">2021</a>)</span> for an in-depth discussion on the tree-based models.</p>
</section></section><section id="sec-causal" class="level2" data-number="13.4"><h2 data-number="13.4" class="anchored" data-anchor-id="sec-causal">
<span class="header-section-number">13.4</span> Causal inference</h2>
<p>Throughout this text, we have interpreted the coefficients of regression models to describe the <em>association</em> between the response and predictor variables and the “expected” change in the response variable based on the model. In other words, we have been bound by the common phrase in statistics “correlation does not equal causation.” There are many situations in practice, however, in which we want to make a stronger claim and conclude that “X causes Y.” For example, medical researchers developing a new treatment want to know if the treatment causes improved health outcomes. In social sciences, researchers may want to know if a particular social program improves outcomes for individuals living in poverty. Economists want to know the impact of changing economic measures, such as interest rates, on the economy overall. Each of these scenarios requires an analysis that can more thoroughly account for <strong>confounding variables</strong>, underlying variables that impact both the response and predictor variables, so that the impact of the medical treatment, social program, or economic measure can be quantified. We will refer to all of these as <em>treatment</em> or <em>intervention</em> throughout the rest of the section.</p>
<p>The ability to make causal claims start with the data. There are two types of data: experimental and observational data. <strong>Experimental data</strong> are data obtained from a randomized-control experiment <!--# is this the correct term--> in which individuals were randomly assigned to the treatment group that receives the intervention or control group that does not receive the intervention. Because individuals are randomly assigned groups, we can assume the only difference between the treatment and control groups is the intervention itself. Therefore, as we interpret the model coefficients associated with the treatment, we can interpret it in terms of how a change in the treatment <u><strong>causes</strong></u> in a change in the response.</p>
<p>The ideal randomized experiment is often not feasible in practice due to a variety of factors. For example, it may be unethical to assign individuals to a control group and withhold beneficial treatment, or it is not feasible to restrict the behavior of individuals to implement experimental conditions. Therefore, researchers often rely on observational data, even when they want to draw conclusions stronger than a “correlation” or “association” between some treatment or intervention (predictor) and an outcome (response). To make such causal claims, we use statistical methods to make the observational data “look” more like data from a randomized experiment. These methods make up the branch of statistics called <em>causal inference</em>.</p>
<section id="propensity-score-matching" class="level3" data-number="13.4.1"><h3 data-number="13.4.1" class="anchored" data-anchor-id="propensity-score-matching">
<span class="header-section-number">13.4.1</span> Propensity score matching</h3>
<p>In <strong>propensity score matching</strong>, we compute the probability (propensity) an observation is assigned to the treatment group based on a set of confounding variables that directly impact both the response and the likelihood an individual is in the treatment group. We then match individuals in the treatment and control groups who have the same or similar propensities to create a new data set in which the control and treatment groups have similar characteristics. The matched data set is used to estimate the effect of the treatment. <!--# use exchangeability here?--></p>
<p>Let’s apply propensity score matching to evaluate the effect of an educational program, Project ACE: Action for Equity. Project ACE was a “five year interdisciplinary program aimed to get more underrepresented high school students from disadvantaged backgrounds to get interested in college degrees in engineering as well as biomedical and behavioral sciences” <span class="citation" data-cites="ProjectACE_UTEP">(<a href="references.html#ref-ProjectACE_UTEP" role="doc-biblioref">Texas at El Paso College of Liberal Arts n.d.</a>)</span>. We will analyze data from <span class="citation" data-cites="evans2025testing">Evans, Perez, and Morera (<a href="references.html#ref-evans2025testing" role="doc-biblioref">2025</a>)</span> who use propensity score matching to analyze outcomes of high school students. The data are available in <code>project-ace-data.csv</code>. We will follow their analysis closely with some modifications, so we refer readers to their article for the full analysis.</p>
<p>We will use the variables below. The definitions are adapted from <span class="citation" data-cites="evans2025testing">Evans, Perez, and Morera (<a href="references.html#ref-evans2025testing" role="doc-biblioref">2025</a>)</span>.</p>
<ul>
<li>
<code>Grade</code>: Grade level (9, 10, 11, 12)</li>
<li>
<code>Gender</code>: Gender (F, M)</li>
<li>
<code>Ethnicity</code>: Ethnicity (Hispanic, Non-Hispanic)</li>
<li>
<code>ELL</code>: Whether student is an English language learner (N, Y)</li>
<li>
<code>Sped</code>: Whether student is in a special education program (N, Y)</li>
<li>
<code>Homeless</code>: Whether student is homeless (N, Y)</li>
<li>
<code>Tracking.Pathway</code>: Whether student was in Project ACE (Treatment) or not (Control)</li>
<li>
<code>Current.GPA</code>: Grade Point Average (GPA) ranging 0 to 5.0</li>
</ul>
<div class="cell">
<div class="cell-output-display">
<div id="fig-response-gpa" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-response-gpa-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="13-special-topics_files/figure-html/fig-response-gpa-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-20" title="Figure&nbsp;13.13: Distribution of GPA for treatment and control groups"><img src="13-special-topics_files/figure-html/fig-response-gpa-1.png" class="img-fluid figure-img" style="width:100.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-response-gpa-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13.13: Distribution of GPA for treatment and control groups
</figcaption></figure>
</div>
</div>
</div>
<p><a href="#fig-response-gpa" class="quarto-xref">Figure&nbsp;<span>13.13</span></a> shows the distribution of the response variable <code>Current.GPA</code> for the treatment and control groups. There is a lot of overlap in the distributions, but there does appear to be a higher proportion of students in the treatment group who have higher GPAs. The goal of this analysis is to measure if there is a difference in the GPAs between students in Project ACE versus those not in the program, and if so, the effect of the Project ACE on GPA.</p>
<p>Some variables are associated with both the response and the chance to receiving the treatment. For example, research shows that demographic and socioeconomic variables are associated with academic performance <span class="citation" data-cites="evans2025testing">(<a href="references.html#ref-evans2025testing" role="doc-biblioref">Evans, Perez, and Morera 2025</a>)</span>. Because Project ACE is aimed at students who are “underrepresented” and from “disadvantaged backgrounds”, demographic and socioeconomic factors are also associated with the probability of being in the program. We see examples of this in <a href="#fig-compare-distributions" class="quarto-xref">Figure&nbsp;<span>13.14</span></a>, where the distributions of three potential covariates differ between control and treatment groups.</p>
<div id="fig-compare-distributions" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-compare-distributions-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-compare-distributions" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-compare-distributions-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-compare-distributions-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="13-special-topics_files/figure-html/fig-compare-distributions-1.png" class="lightbox" data-gallery="fig-compare-distributions" title="Figure&nbsp;13.14&nbsp;(a): Grade"><img src="13-special-topics_files/figure-html/fig-compare-distributions-1.png" class="img-fluid figure-img" style="width:100.0%" data-ref-parent="fig-compare-distributions"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-compare-distributions-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) <code>Grade</code>
</figcaption></figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-compare-distributions" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-compare-distributions-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-compare-distributions-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="13-special-topics_files/figure-html/fig-compare-distributions-2.png" class="lightbox" data-gallery="fig-compare-distributions" title="Figure&nbsp;13.14&nbsp;(b): Gender"><img src="13-special-topics_files/figure-html/fig-compare-distributions-2.png" class="img-fluid figure-img" style="width:100.0%" data-ref-parent="fig-compare-distributions"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-compare-distributions-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) <code>Gender</code>
</figcaption></figure>
</div>
</div>
</div>
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-compare-distributions" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-compare-distributions-3" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-compare-distributions-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="13-special-topics_files/figure-html/fig-compare-distributions-3.png" class="lightbox" data-gallery="fig-compare-distributions" title="Figure&nbsp;13.14&nbsp;(c): ELL"><img src="13-special-topics_files/figure-html/fig-compare-distributions-3.png" class="img-fluid figure-img" style="width:100.0%" data-ref-parent="fig-compare-distributions"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-compare-distributions-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c) <code>ELL</code>
</figcaption></figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-compare-distributions-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13.14: Distribution of Subset of confounding variables for treatment and control groups.
</figcaption></figure>
</div>
<p>In a standard regression model, these variables and the other demographic and socioeconomic variables would be confounders that limit the strength of the claim we can make about the effect of the treatment, even if these variables are included as predictors in the model. Therefore, we will match the data in a way such that the distributions of these factors are similar between the treatment and control groups.</p>
<div class="analysis_in_practice">
<p>Choosing the variables to include in the propensity score model can be challenging. We often choose these variables based on previous research and collaboration with individuals who are domain experts. Deciding up front which variables are important helps strengthen the analysis conclusions, as there is less potential there are confounding variables impacting the model of the treatment effect.</p>
</div>
<!--# We will just look at a few characteristics here, but will use many more in the PSM-->
<!--# We will not use Free.Lunch bc it is coded as Y for all observations in the available data.-->
<p>The propensity score model is a logistic regression model where the response variable is the binary indicator for Treatment vs.&nbsp;Control. As shown in <a href="#eq-propensity-score-model" class="quarto-xref">Equation&nbsp;<span>13.7</span></a>, we use this model to compute the probability that an individual is in the treatment group. The form of the propensity score model for this analysis is as follows:</p>
<p><span id="eq-propensity-score-model"><span class="math display">\[
\begin{aligned}
\log\Big(\frac{\pi}{1-\pi}\Big) = \beta_0 &amp;+ \beta_1 ~ \text{Grade10} + \beta_2 ~ \text{Grade11} + \beta_3 ~ \text{Grade12}  \\
&amp; + \beta_4 ~ \text{GenderM} + \beta_5 ~ \text{EthnicityNon-Hispanic} \\
&amp;+ \beta_6 ~ \text{ELL} + \beta_7 ~ \text{Sped} + \beta_8 ~ \text{Homeless}
\end{aligned}
\tag{13.7}\]</span></span> where <span class="math inline">\(\pi\)</span> is the propensity, the probability of being in the treatment group (participating in Project ACE). <a href="#tbl-propensity-score-model" class="quarto-xref">Table&nbsp;<span>13.6</span></a> is the output of the fitted propensity score model. <!--# foot note: All the variables in this model happen to be categorical, but both quantitative and categorical variables can be used in the propensity score model.--></p>
<div class="cell">
<div id="tbl-propensity-score-model" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl quarto-uncaptioned" id="tbl-propensity-score-model-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;13.6
</figcaption><div aria-describedby="tbl-propensity-score-model-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 48%">
<col style="width: 12%">
<col style="width: 13%">
<col style="width: 13%">
<col style="width: 11%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">term</th>
<th style="text-align: right;">estimate</th>
<th style="text-align: right;">std.error</th>
<th style="text-align: right;">statistic</th>
<th style="text-align: right;">p.value</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: right;">-1.670</td>
<td style="text-align: right;">0.216</td>
<td style="text-align: right;">-7.733</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">Grade10</td>
<td style="text-align: right;">0.539</td>
<td style="text-align: right;">0.264</td>
<td style="text-align: right;">2.040</td>
<td style="text-align: right;">0.041</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Grade11</td>
<td style="text-align: right;">0.566</td>
<td style="text-align: right;">0.263</td>
<td style="text-align: right;">2.155</td>
<td style="text-align: right;">0.031</td>
</tr>
<tr class="even">
<td style="text-align: left;">Grade12</td>
<td style="text-align: right;">0.314</td>
<td style="text-align: right;">0.273</td>
<td style="text-align: right;">1.151</td>
<td style="text-align: right;">0.250</td>
</tr>
<tr class="odd">
<td style="text-align: left;">GenderM</td>
<td style="text-align: right;">-1.390</td>
<td style="text-align: right;">0.206</td>
<td style="text-align: right;">-6.731</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">Ethnicity.Hispanic.Y.NNon Hispanic</td>
<td style="text-align: right;">-0.498</td>
<td style="text-align: right;">0.775</td>
<td style="text-align: right;">-0.643</td>
<td style="text-align: right;">0.520</td>
</tr>
<tr class="odd">
<td style="text-align: left;">ELLY</td>
<td style="text-align: right;">-0.792</td>
<td style="text-align: right;">0.222</td>
<td style="text-align: right;">-3.562</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">SpedY</td>
<td style="text-align: right;">0.017</td>
<td style="text-align: right;">0.277</td>
<td style="text-align: right;">0.060</td>
<td style="text-align: right;">0.952</td>
</tr>
<tr class="odd">
<td style="text-align: left;">HomelessY</td>
<td style="text-align: right;">1.126</td>
<td style="text-align: right;">0.649</td>
<td style="text-align: right;">1.734</td>
<td style="text-align: right;">0.083</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>In general, we are not interested in interpreting the coefficients of the propensity score model but rather using it to compute the propensity for each observation. Before using the propensity scores to match, let’s take a look at the distribution of propensity scores for the treatment and control group in <a href="#fig-propensity-scores" class="quarto-xref">Figure&nbsp;<span>13.15</span></a>.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-propensity-scores" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-propensity-scores-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="13-special-topics_files/figure-html/fig-propensity-scores-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-24" title="Figure&nbsp;13.15: Distribution of propensity scores for treatment and control groups"><img src="13-special-topics_files/figure-html/fig-propensity-scores-1.png" class="img-fluid figure-img" style="width:100.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-propensity-scores-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13.15: Distribution of propensity scores for treatment and control groups
</figcaption></figure>
</div>
</div>
</div>
<p>In <a href="#fig-propensity-scores" class="quarto-xref">Figure&nbsp;<span>13.15</span></a>, we see that the center of the distribution of propensity scores for individuals in the treatment group is higher than the center for the control group. This is what we might expect, because the individuals in the treatment group are more likely to have the characteristics of eligibility to participate in Project ACE.</p>
<p>The other important feature from this graph is the large overlap between the two distributions. This indicates <strong>common support</strong>, in which individuals in both the treatment and control groups have a nonzero probability of receiving the treatment. In the context of this analysis, this means every student had a non-zero chance of participating in Project ACE. Practically speaking, we use the propensity scores to match observations in the treatment group with an observation in the control group, so there needs to be overlap in the distributions.</p>
<p>Now let’s use the propensity scores to match observations. The number of observations in the treatment group is often equal to or less than the number of observations in the control group. Therefore, the matching is done such that each observation in the treatment group is matched to an observation in the control group. Then, the observations in the control group that are not matched are discarded. In the Project ACE analysis, there are 148 observations in the treatment group and 1152 observations in the control group. Therefore, the final matched data set will contain 148 observations in the treatment group and 148 observations in the control group. The unmatched 1004 observations in the control group are discarded.</p>
<p>One of the most widely used matching approaches is <strong>nearest-neighbor matching</strong>, in which each observation in the treatment group is matched with an observation in the control group with the closest propensity score. <a href="#tbl-sample-matches" class="quarto-xref">Table&nbsp;<span>13.7</span></a> shows three treatment/control pairs in the matched data for the Project ACE analysis.</p>
<div class="cell">
<div id="tbl-sample-matches" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-sample-matches-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;13.7: Three pairs of matched observations based on the model in <a href="#tbl-propensity-score-model" class="quarto-xref">Table&nbsp;<span>13.6</span></a>. The column <code>subclass</code> identifies the matches.
</figcaption><div aria-describedby="tbl-sample-matches-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<thead><tr class="header">
<th style="text-align: left;">subclass</th>
<th style="text-align: left;">Tracking.Pathway</th>
<th style="text-align: right;">propensity_score</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">14</td>
<td style="text-align: left;">Control</td>
<td style="text-align: right;">0.367</td>
</tr>
<tr class="even">
<td style="text-align: left;">14</td>
<td style="text-align: left;">Treatment</td>
<td style="text-align: right;">0.443</td>
</tr>
<tr class="odd">
<td style="text-align: left;">50</td>
<td style="text-align: left;">Control</td>
<td style="text-align: right;">0.249</td>
</tr>
<tr class="even">
<td style="text-align: left;">50</td>
<td style="text-align: left;">Treatment</td>
<td style="text-align: right;">0.249</td>
</tr>
<tr class="odd">
<td style="text-align: left;">118</td>
<td style="text-align: left;">Control</td>
<td style="text-align: right;">0.158</td>
</tr>
<tr class="even">
<td style="text-align: left;">118</td>
<td style="text-align: left;">Treatment</td>
<td style="text-align: right;">0.158</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>Sometimes there are <strong>exact matches</strong>, where an observation in the treatment group is matched with an observation in the control group with an equal propensity score. Matches 50 and 118 in the table are examples of this. This generally indicates that the two observations are the same in terms of the characteristics included in the propensity score model <a href="#eq-propensity-score-model" class="quarto-xref">Equation&nbsp;<span>13.7</span></a>. In other cases, such as Match 14, the scores are close but not exact.</p>
<div class="cell">
<div id="tbl-match-14" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-match-14-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;13.8: Features for observations in Match 14
</figcaption><div aria-describedby="tbl-match-14-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 19%">
<col style="width: 6%">
<col style="width: 7%">
<col style="width: 26%">
<col style="width: 4%">
<col style="width: 5%">
<col style="width: 10%">
<col style="width: 19%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">Tracking.Pathway</th>
<th style="text-align: left;">Grade</th>
<th style="text-align: left;">Gender</th>
<th style="text-align: left;">Ethnicity.Hispanic.Y.N</th>
<th style="text-align: left;">ELL</th>
<th style="text-align: left;">Sped</th>
<th style="text-align: left;">Homeless</th>
<th style="text-align: right;">propensity_score</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Treatment</td>
<td style="text-align: left;">12</td>
<td style="text-align: left;">F</td>
<td style="text-align: left;">Hispanic</td>
<td style="text-align: left;">N</td>
<td style="text-align: left;">N</td>
<td style="text-align: left;">Y</td>
<td style="text-align: right;">0.443</td>
</tr>
<tr class="even">
<td style="text-align: left;">Control</td>
<td style="text-align: left;">9</td>
<td style="text-align: left;">F</td>
<td style="text-align: left;">Hispanic</td>
<td style="text-align: left;">N</td>
<td style="text-align: left;">N</td>
<td style="text-align: left;">Y</td>
<td style="text-align: right;">0.367</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>From <a href="#tbl-match-14" class="quarto-xref">Table&nbsp;<span>13.8</span></a>, we see that the two observations that make up the 14th match are the same in all characteristics except grade. The student in the treatment group is in grade 12, and the student in the control group is in grade 9.</p>
<!--# to add - analysis in practice - what about the nonmatched observations? Do ratios-->
<p>Before fitting the model to estimate the effect of the treatment, let’s take a look at the distributions of the variables we examined in <a href="#fig-compare-distributions" class="quarto-xref">Figure&nbsp;<span>13.14</span></a>, and see how the distributions compare between the treatment and control group for the 296 observations in the matched data.</p>
<div id="fig-compare-distributions-matched" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-compare-distributions-matched-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-compare-distributions-matched" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-compare-distributions-matched-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-compare-distributions-matched-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="13-special-topics_files/figure-html/fig-compare-distributions-matched-1.png" class="lightbox" data-gallery="fig-compare-distributions-matched" title="Figure&nbsp;13.16&nbsp;(a): Grade"><img src="13-special-topics_files/figure-html/fig-compare-distributions-matched-1.png" class="img-fluid figure-img" style="width:100.0%" data-ref-parent="fig-compare-distributions-matched"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-compare-distributions-matched-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) <code>Grade</code>
</figcaption></figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-compare-distributions-matched" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-compare-distributions-matched-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-compare-distributions-matched-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="13-special-topics_files/figure-html/fig-compare-distributions-matched-2.png" class="lightbox" data-gallery="fig-compare-distributions-matched" title="Figure&nbsp;13.16&nbsp;(b): Gender"><img src="13-special-topics_files/figure-html/fig-compare-distributions-matched-2.png" class="img-fluid figure-img" style="width:100.0%" data-ref-parent="fig-compare-distributions-matched"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-compare-distributions-matched-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) <code>Gender</code>
</figcaption></figure>
</div>
</div>
</div>
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-compare-distributions-matched" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-compare-distributions-matched-3" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-compare-distributions-matched-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="13-special-topics_files/figure-html/fig-compare-distributions-matched-3.png" class="lightbox" data-gallery="fig-compare-distributions-matched" title="Figure&nbsp;13.16&nbsp;(c): ELL"><img src="13-special-topics_files/figure-html/fig-compare-distributions-matched-3.png" class="img-fluid figure-img" style="width:100.0%" data-ref-parent="fig-compare-distributions-matched"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-compare-distributions-matched-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c) <code>ELL</code>
</figcaption></figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-compare-distributions-matched-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13.16: Distribution of subset of confounding variables for treatment versus control groups in the matched data.
</figcaption></figure>
</div>
<p>In <a href="#fig-compare-distributions-matched" class="quarto-xref">Figure&nbsp;<span>13.16</span></a>, the distributions of these student characteristics are now the same for the treatment and control groups (compare to <a href="#fig-compare-distributions" class="quarto-xref">Figure&nbsp;<span>13.14</span></a>). For brevity, we only show three variables here, but we could look at the distributions for all variables in the propensity score model <a href="#eq-propensity-score-model" class="quarto-xref">Equation&nbsp;<span>13.7</span></a>. Now the data look more like what we would expect in a randomized experiment. Therefore, we can be more confident that any differences in the GPA (response variable) are due to the treatment and not underlying confounding variables. <!--# need to make sure I define confounding somewhere--></p>
<p>Once we have the matched data set, it’s time to evaluate the effect of the treatment. We do this by using a regression model with the treatment as a predictor.</p>
<p><span id="eq-treatment-model"><span class="math display">\[
\text{GPA} = \beta_0 + \beta_1 ~\text{Treatment} + \epsilon \hspace{8mm} \epsilon \sim N(0, \sigma^2_{\epsilon})
\tag{13.8}\]</span></span> For the Project ACE analysis, the response variable GPA is quantitative, so we use a linear regression model of the form in <a href="#eq-treatment-model" class="quarto-xref">Equation&nbsp;<span>13.8</span></a>. The fitted model is in <a href="#tbl-model-treatment-effect" class="quarto-xref">Table&nbsp;<span>13.9</span></a>.</p>
<div class="cell">
<div id="tbl-model-treatment-effect" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-model-treatment-effect-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;13.9: Model of treatment effect with 95% confidence intervals for coefficients
</figcaption><div aria-describedby="tbl-model-treatment-effect-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 31%">
<col style="width: 10%">
<col style="width: 12%">
<col style="width: 12%">
<col style="width: 9%">
<col style="width: 10%">
<col style="width: 12%">
</colgroup>
<thead><tr class="header">
<th style="text-align: left;">term</th>
<th style="text-align: right;">estimate</th>
<th style="text-align: right;">std.error</th>
<th style="text-align: right;">statistic</th>
<th style="text-align: right;">p.value</th>
<th style="text-align: right;">conf.low</th>
<th style="text-align: right;">conf.high</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: right;">2.430</td>
<td style="text-align: right;">0.069</td>
<td style="text-align: right;">35</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">2.294</td>
<td style="text-align: right;">2.57</td>
</tr>
<tr class="even">
<td style="text-align: left;">Tracking.PathwayTreatment</td>
<td style="text-align: right;">0.196</td>
<td style="text-align: right;">0.098</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0.046</td>
<td style="text-align: right;">0.003</td>
<td style="text-align: right;">0.39</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>We interpret the model just as we interpret other linear regression models (see <a href="04-slr.html" class="quarto-xref"><span>Chapter 4</span></a> and <a href="07-mlr.html" class="quarto-xref"><span>Chapter 7</span></a>). In <a href="#tbl-model-treatment-effect" class="quarto-xref">Table&nbsp;<span>13.9</span></a>, the estimated effect of the treatment, participating in Project ACE is 0.196 and the 95% confidence interval is 0.003 to 0.39. This estimate 0.196 is the <strong>average treatment effect (ATE)</strong>, the difference in the expected response between the treatment and control group. Therefore, based on this analysis, we can make a causal relationship between participating in Project ACE and higher GPA, on average. The 95% confidence interval gives a plausible range for the effect in the population.</p>
<div class="yourturn">
<p>Interpret the 95% confidence interval for the effect of participating in Project ACE in the context of the data.<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a></p>
</div>
<p>As we use these results to inform decision-making, one thing to keep in mind is that this is the average treatment effect in the matched population. Therefore, the results may not generalize to the entire population if the discarded individuals in the control group are significantly different from the individuals in the matched group. One way to mitigate this is to include more observations from the control group. Strategies for this are available in the resources at the end of this section.</p>
</section><section id="causal-inference-in-r" class="level3" data-number="13.4.2"><h3 data-number="13.4.2" class="anchored" data-anchor-id="causal-inference-in-r">
<span class="header-section-number">13.4.2</span> Causal inference in R</h3>
<p>Much of the code for causal inference is the code for linear <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code> and logistic <code><a href="https://rdrr.io/r/stats/glm.html">glm()</a></code> models that we’ve seen in previous chapters. The primarily new code is for creating the matched data set using the propensity scores.</p>
<p>We compute the propensity scores “manually” by fitting a logistic regression model using <code><a href="https://rdrr.io/r/stats/glm.html">glm()</a></code>.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">propensity_score_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span><span class="va">Tracking.Pathway</span> <span class="op">~</span> <span class="va">Grade</span> <span class="op">+</span> <span class="va">Gender</span> <span class="op">+</span> </span>
<span>                                <span class="va">Ethnicity.Hispanic.Y.N</span> <span class="op">+</span> <span class="va">ELL</span> <span class="op">+</span> </span>
<span>                                <span class="va">Sped</span> <span class="op">+</span> <span class="va">Homeless</span>,</span>
<span>                        data <span class="op">=</span> <span class="va">ace</span>, </span>
<span>                        family <span class="op">=</span> <span class="st">"binomial"</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The assigned matches are done using the <code>matchit()</code> function from the <strong>MatchIt</strong> R package <span class="citation" data-cites="MatchIt">(<a href="references.html#ref-MatchIt" role="doc-biblioref">Ho et al. 2011</a>)</span>. The code below shows the propensity score matching for the Project Ace data.</p>
<p>The argument <code>method = "nearest"</code> species to conduct nearest-neighbor matching (the default method), and <code>distance = "logit"</code> indicates to compute the propensity scores using a logistic regression model. The <code>matchit()</code> function will refit the model with propensity scores.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ace_psm</span> <span class="op">&lt;-</span> <span class="fu">matchit</span><span class="op">(</span><span class="va">Tracking.Pathway</span> <span class="op">~</span> <span class="va">Grade</span> <span class="op">+</span> <span class="va">Gender</span> <span class="op">+</span> <span class="va">Ethnicity.Hispanic.Y.N</span> <span class="op">+</span></span>
<span>                          <span class="va">Race</span> <span class="op">+</span> <span class="va">ELL</span> <span class="op">+</span> <span class="va">Sped</span> <span class="op">+</span> <span class="va">Homeless</span>,</span>
<span>                 data <span class="op">=</span> <span class="va">ace</span>,</span>
<span>                 method <span class="op">=</span> <span class="st">"nearest"</span>,   </span>
<span>                 distance <span class="op">=</span> <span class="st">"logit"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ace_psm</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>A `matchit` object
 - method: 1:1 nearest neighbor matching without replacement
 - distance: Propensity score
             - estimated with logistic regression
 - number of obs.: 1300 (original), 296 (matched)
 - target estimand: ATT
 - covariates: Grade, Gender, Ethnicity.Hispanic.Y.N, Race, ELL, Sped, Homeless</code></pre>
</div>
</div>
<p>This code creates a <code>matchit</code> object called <code>ace_psm</code> that contains information about the propensity score matching. We retrieve the matched data using the <code>match.data()</code> function as shown below.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ace_matched</span> <span class="op">&lt;-</span> <span class="fu">match.data</span><span class="op">(</span><span class="va">ace_psm</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We use <code>glimpse()</code> to see what is in the new matched data set.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 296
Columns: 17
$ Student.ID                                        &lt;dbl&gt; 9478, 8268, 9846, 22…
$ Grade                                             &lt;fct&gt; 12, 12, 12, 12, 11, …
$ Gender                                            &lt;chr&gt; "M", "M", "F", "F", …
$ Race                                              &lt;chr&gt; "C", "C", "C", "C", …
$ Ethnicity.Hispanic.Y.N                            &lt;chr&gt; "Hispanic", "Hispani…
$ ELL                                               &lt;chr&gt; "N", "N", "N", "N", …
$ Sped                                              &lt;chr&gt; "N", "N", "N", "N", …
$ Homeless                                          &lt;chr&gt; "N", "N", "Y", "N", …
$ Free.Lunch                                        &lt;chr&gt; "Y", "Y", "Y", "Y", …
$ Migrant                                           &lt;chr&gt; "N", "N", "N", "N", …
$ Current.GPA                                       &lt;dbl&gt; 1.45, 2.96, 2.96, 3.…
$ Number.of.Classes.Enrolled.in.for.the.school.year &lt;dbl&gt; 7, 7, 7, 7, 7, 7, 7,…
$ Tracking.Pathway                                  &lt;fct&gt; Control, Treatment, …
$ propensity_score                                  &lt;dbl&gt; 0.0603, 0.0603, 0.44…
$ distance                                          &lt;dbl&gt; 0.0590, 0.0590, 0.45…
$ weights                                           &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1,…
$ subclass                                          &lt;fct&gt; 1, 1, 42, 3, 2, 2, 4…</code></pre>
</div>
</div>
<p>There are some new columns in addition to the columns in the original <code>ace</code> tibble. The column <code>distance</code> contains the propensity scores. The column <code>sub.class</code> identifies the matches. The column <code>weights</code> contains sample weights. All observations are equally weighted using the methods introduced in this section. See the resources in <a href="#sec-causal-further-reading" class="quarto-xref"><span>Section 13.4.3</span></a> to learn about propensity score matching that incorporates weighting.</p>
<p>The <code>lm</code> function is used to fit the linear regression model for the treatment effect.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">treatment_effect</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">Current.GPA</span> <span class="op">~</span> <span class="va">Tracking.Pathway</span>, data <span class="op">=</span> <span class="va">ace_matched</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section><section id="sec-causal-further-reading" class="level3" data-number="13.4.3"><h3 data-number="13.4.3" class="anchored" data-anchor-id="sec-causal-further-reading">
<span class="header-section-number">13.4.3</span> Further reading</h3>
<p>Given the plethora of data available today, it is no surprise that causal inference is a rich and growing field in statistics and data science. We refer interested readers to <em>The effect: An introduction to research design and causality</em> <span class="citation" data-cites="huntington2021effect">(<a href="references.html#ref-huntington2021effect" role="doc-biblioref">Huntington-Klein 2021</a>)</span> and <em>Causal Inference: The Mixtape</em> <span class="citation" data-cites="cunningham2021causal">(<a href="references.html#ref-cunningham2021causal" role="doc-biblioref">Cunningham 2021</a>)</span> for an introduction to causal inference on observational data and <em>Design and Analysis of Experiments</em> <span class="citation" data-cites="montgomery2017design">(<a href="references.html#ref-montgomery2017design" role="doc-biblioref">Montgomery 2017</a>)</span> for an introduction to experimental design.</p>
</section></section><section id="summary" class="level2" data-number="13.5"><h2 data-number="13.5" class="anchored" data-anchor-id="summary">
<span class="header-section-number">13.5</span> Summary</h2>
<p>In this chapter, we introduced models that are extensions of linear and logistic regression. Specifically, we introduced the multinomial logistic regression model for categorical response variables with at least three levels, the random intercepts model for data with correlated observations, decision trees for prediction, and propensity scores models for causal inference. The goal of this book is to introduce readers to regression analysis, so this chapter is a springboard for readers interested in learning more about modeling. All the resources mentioned throughout the chapter are a nice followup to this text for readers interested in a deeper dive into the special topics introduced here and much more.</p>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-lme4" class="csl-entry" role="listitem">
Bates, Douglas, Martin Maechler, Ben Bolker, and Steve Walker. 2015. <span>“Fitting Linear Mixed-Effects Models Using <span></span>Lme4<span></span>”</span> 67. <a href="https://doi.org/10.18637/jss.v067.i01">https://doi.org/10.18637/jss.v067.i01</a>.
</div>
<div id="ref-broom.mixed" class="csl-entry" role="listitem">
Bolker, Ben, and David Robinson. 2024. <span>“Broom.mixed: Tidying Methods for Mixed Models.”</span> <a href="https://doi.org/10.32614/CRAN.package.broom.mixed">https://doi.org/10.32614/CRAN.package.broom.mixed</a>.
</div>
<div id="ref-tidytuesday" class="csl-entry" role="listitem">
Community, Data Science Learning. 2024. <span>“Tidy Tuesday: A Weekly Social Data Project.”</span> <a href="https://tidytues.day">https://tidytues.day</a>.
</div>
<div id="ref-cunningham2021causal" class="csl-entry" role="listitem">
Cunningham, Scott. 2021. <em>Causal Inference: The Mixtape</em>. Yale university press.
</div>
<div id="ref-evans2025testing" class="csl-entry" role="listitem">
Evans, Nicholas D, Perla C Perez, and Osvaldo F Morera. 2025. <span>“Testing the Efficacy of Educational Interventions on Matched Student Samples: A Primer for Propensity Score Matching in r.”</span> <em>Journal of STEM Outreach</em> 8 (1): 1–9.
</div>
<div id="ref-gelman2007data" class="csl-entry" role="listitem">
Gelman, Andrew, and Jennifer Hill. 2007. <em>Data Analysis Using Regression and Multilevel/Hierarchical Models</em>. Cambridge university press.
</div>
<div id="ref-MatchIt" class="csl-entry" role="listitem">
Ho, Daniel E., Kosuke Imai, Gary King, and Elizabeth A. Stuart. 2011. <span>“<span></span>MatchIt<span></span>: Nonparametric Preprocessing for Parametric Causal Inference”</span> 42. <a href="https://doi.org/10.18637/jss.v042.i08">https://doi.org/10.18637/jss.v042.i08</a>.
</div>
<div id="ref-huntington2021effect" class="csl-entry" role="listitem">
Huntington-Klein, Nick. 2021. <em>The Effect: An Introduction to Research Design and Causality</em>. Chapman; Hall/CRC.
</div>
<div id="ref-james2021introduction" class="csl-entry" role="listitem">
James, Gareth, Daniela Witten, Trevor Hastie, and Robert Tibshirani. 2021. <em>An Introduction to Statistical Learning: With Applications in r</em>. 2nd ed. Springer.
</div>
<div id="ref-yardstick" class="csl-entry" role="listitem">
Kuhn, Max, Davis Vaughan, and Emil Hvitfeldt. 2025. <span>“Yardstick: Tidy Characterizations of Model Performance.”</span> <a href="https://doi.org/10.32614/CRAN.package.yardstick">https://doi.org/10.32614/CRAN.package.yardstick</a>.
</div>
<div id="ref-rpart.plot" class="csl-entry" role="listitem">
Milborrow, Stephen. 2025. <span>“Rpart.plot: Plot ’Rpart’ Models: An Enhanced Version of ’Plot.rpart’.”</span> <a href="https://doi.org/10.32614/CRAN.package.rpart.plot">https://doi.org/10.32614/CRAN.package.rpart.plot</a>.
</div>
<div id="ref-montgomery2017design" class="csl-entry" role="listitem">
Montgomery, Douglas C. 2017. <em>Design and Analysis of Experiments</em>. John wiley &amp; sons.
</div>
<div id="ref-roback2021beyond" class="csl-entry" role="listitem">
Roback, Paul, and Julie Legler. 2021. <em>Beyond Multiple Linear Regression: Applied Generalized Linear Models and Multilevel Models in r</em>. Chapman; Hall/CRC.
</div>
<div id="ref-broom" class="csl-entry" role="listitem">
Robinson, David, Alex Hayes, and Simon Couch. 2023. <span>“Broom: Convert Statistical Objects into Tidy Tibbles.”</span> <a href="https://CRAN.R-project.org/package=broom">https://CRAN.R-project.org/package=broom</a>.
</div>
<div id="ref-ProjectACE_UTEP" class="csl-entry" role="listitem">
Texas at El Paso College of Liberal Arts, The University of. n.d. <span>“Project ACE: Action for Equity.”</span> <a href="https://www.utep.edu/liberalarts/project-ace/" class="uri">https://www.utep.edu/liberalarts/project-ace/</a>.
</div>
<div id="ref-rpart" class="csl-entry" role="listitem">
Therneau, Terry, and Beth Atkinson. 2025. <span>“Rpart: Recursive Partitioning and Regression Trees.”</span> <a href="https://doi.org/10.32614/CRAN.package.rpart">https://doi.org/10.32614/CRAN.package.rpart</a>.
</div>
<div id="ref-ThomsonDeVeaux_et_al_2020" class="csl-entry" role="listitem">
Thomson-DeVeaux, Amelia, Jasmine Mithani, and Laura Bronner. 2020. <span>“Why Many Americans Don’t Vote.”</span> <em>FiveThirtyEight</em>. <a href="https://web.archive.org/web/20201102013301/https://projects.fivethirtyeight.com/non-voters-poll-2020-election/">https://web.archive.org/web/20201102013301/https://projects.fivethirtyeight.com/non-voters-poll-2020-election/</a>.
</div>
<div id="ref-nnet" class="csl-entry" role="listitem">
Venables, W. N., and B. D. Ripley. 2002. <span>“Modern Applied Statistics with s.”</span> <a href="https://www.stats.ox.ac.uk/pub/MASS4/">https://www.stats.ox.ac.uk/pub/MASS4/</a>.
</div>
<div id="ref-knitr" class="csl-entry" role="listitem">
Xie, Yihui. 2024. <span>“Knitr: A General-Purpose Package for Dynamic Report Generation in r.”</span> <a href="https://yihui.org/knitr/">https://yihui.org/knitr/</a>.
</div>
</div>
</section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><hr>
<ol>
<li id="fn1"><p>Similar to how categorical predictors are interpreted as one level versus the baseline (<a href="07-mlr.html#sec-mlr-interpret-categorical" class="quarto-xref">see&nbsp;<span>7.4.2</span></a>).<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>The accuracy is the 0.493 <span class="math inline">\((563 + 2219 + 94)/5836)\)</span>. The misclassification rate is 0.507 <span class="math inline">\((1 - 0.407)\)</span>.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>We can also specify the GLMMs to account for the different slopes of age across the lemurs. That is beyond the scope of this text, but we provide resources at the end of the section for readers interested in learning more.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4">
<p><code>age:</code> As a lemur gets one month older, its weight is expected to increase by 147.719 grams, on average, after adjusting for taxon, sex, and litter size.</p>
<p><span class="math inline">\(\hat{\sigma}_u = 311.504\)</span>: The variability in the average weights between lemurs is 311.504. On average, the mean weight of an individual lemur is 311.504 grams away from the overall mean weight of all lemurs.<br><a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p>
</li>
<li id="fn5"><p>The predicted expenditure is 2.1 million. Note that the fact that it was a public institution was not used based on its path in the decision tree.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p>The predicted voting frequency is sporadic.<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7"><p>We are 95% confident that improvement in GPA from participating in Project ACE is between 0.003 and 0.39 points.<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/introregressio\.netlify\.app");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./12-logistic-prediction.html" class="pagination-link" aria-label="Logistic regression: Prediction and evaluation">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Logistic regression: Prediction and evaluation</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./appendix-linear.html" class="pagination-link" aria-label="Mathematics of linear regression">
        <span class="nav-page-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Mathematics of linear regression</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/matackett/regression-book/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer><script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>


</body></html>